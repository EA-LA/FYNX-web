<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYNX Tools — ATR Stop Suggestion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#000;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.08);
      --text:#fff;
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.50);
      --danger:#ff4d4d;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 22px;
      --max: 1200px;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x:hidden;
      min-height:100vh;
    }

    /* Animated calc background */
    .animated-bg{
      position:fixed; inset:0; z-index:-1;
      background:#000; overflow:hidden;
    }
    .grid-overlay{
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 52px 52px;
      animation: gridMove 20s linear infinite;
      opacity:.75;
    }
    @keyframes gridMove{
      0%{transform:translate(0,0)}
      100%{transform:translate(52px,52px)}
    }
    .gradient-orb{
      position:absolute; border-radius:999px; filter: blur(80px);
      opacity:.22;
      animation: floaty 18s ease-in-out infinite;
    }
    .orb-1{ width:520px; height:520px; left:-220px; top:-220px; background: radial-gradient(circle, #fff 0%, transparent 65%); }
    .orb-2{ width:520px; height:520px; right:-240px; bottom:-240px; background: radial-gradient(circle, #fff 0%, transparent 65%); animation-delay: 3s;}
    @keyframes floaty{
      0%,100%{transform:translate(0,0) scale(1)}
      50%{transform:translate(30px,-24px) scale(.97)}
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:1000;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border2);
    }
    .nav{
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 850;
      letter-spacing:.4px;
      user-select:none;
    }
    .brand i{opacity:.92}
    .nav-actions{display:flex; align-items:center; gap:10px;}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      text-decoration:none;
      font-weight: 700;
      font-size: 14px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .btn i{opacity:.9}

    /* Layout */
    main{max-width: var(--max); margin:0 auto; padding: 46px 18px 70px;}
    .shell{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--border2);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 26px;
    }
    .title{
      font-size: 44px;
      line-height: 1.04;
      font-weight: 950;
      letter-spacing: -1px;
      margin-bottom: 10px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 15px;
      line-height: 1.55;
      max-width: 980px;
      margin-bottom: 18px;
    }
    @media (max-width: 980px){ .title{font-size: 36px} }

    .cards{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 10px;
    }

    .card{
      border: 1px solid var(--border2);
      background: rgba(0,0,0,.35);
      border-radius: 18px;
      padding: 16px;
    }
    .card h3{
      font-size: 16px;
      font-weight: 950;
      margin-bottom: 12px;
      color: rgba(255,255,255,.92);
      text-transform: uppercase;
      letter-spacing: .6px;
    }

    .chipsRow{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      border:none;
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      white-space:nowrap;
    }
    .chip:hover{transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.16)}
    .chip.active{background: rgba(255,255,255,.20); border-color: rgba(255,255,255,.18)}

    label{
      display:block;
      font-size: 12px;
      font-weight: 950;
      color: rgba(255,255,255,.78);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing:.4px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }

    .field, select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-weight: 900;
      font-size: 14px;
    }
    textarea{
      min-height: 150px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      letter-spacing:.2px;
    }
    .field:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }

    .seg{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 6px;
    }
    .seg button{
      border:none; cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
      font-weight: 950;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .seg button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16)}
    .seg button.active{background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.20); color:#fff}

    .primary{
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.14);
      color: #fff;
      font-weight: 950;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .primary:hover{transform: translateY(-1px); background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.28)}

    .muted{color: var(--muted2); font-size: 12px; line-height: 1.55; font-weight: 800;}
    .danger{color: var(--danger); font-size: 12px; font-weight: 950; margin-top: 10px; display:none;}

    /* Suggestion card styling */
    .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;}
    .pill{
      display:inline-flex; align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .pill.buy{background: rgba(0,255,140,.10); border-color: rgba(0,255,140,.18)}
    .pill.sell{background: rgba(255,80,80,.12); border-color: rgba(255,80,80,.20)}
    .bigBox{
      margin-top: 12px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .bigBox .k{font-size:12px; font-weight:950; color: var(--muted2); text-transform:uppercase; letter-spacing:.4px}
    .bigBox .stop{
      font-size: 22px;
      font-weight: 950;
      letter-spacing:-.3px;
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      margin-top: 4px;
    }
    .bigBox .pips{
      font-size: 14px;
      font-weight: 950;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .pips.buy{background: rgba(255,80,80,.12); border-color: rgba(255,80,80,.20)}
    .pips.sell{background: rgba(0,255,140,.10); border-color: rgba(0,255,140,.18)}

    .rows{margin-top: 10px; display:flex; flex-direction:column; gap:8px}
    .rowLine{
      display:flex; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      font-size: 13px;
    }
    .rowLine span:last-child{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(255,255,255,.90);
    }
  </style>
</head>

<body>
  <div class="animated-bg">
    <div class="grid-overlay"></div>
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
  </div>

  <header>
    <div class="nav">
      <div class="brand"><i class="fa-solid fa-compass-drafting"></i> FYNX Tools</div>
      <div class="nav-actions">
        <a class="btn" href="javascript:history.back()"><i class="fa-solid fa-arrow-left"></i> Back</a>
        <a class="btn" href="../index.html"><i class="fa-solid fa-house"></i> Home</a>
      </div>
    </div>
  </header>

  <main>
    <div class="shell" id="tapDismiss">
      <div class="title">ATR Stop Suggestion</div>
      <div class="subtitle">
        Turn ATR into a smart stop-loss. We use <b>ATR × multiple</b> to suggest a volatility-based stop for your trade.
      </div>

      <div class="cards">

        <!-- Header card -->
        <div class="card" id="headerCard">
          <h3>Overview</h3>
          <div class="pillRow">
            <span class="pill" id="pairPill">EUR/USD</span>
            <span class="pill buy" id="sidePill">Buy setup</span>
          </div>
          <div class="muted" style="margin-top:10px;">
            ATR is measured in price. Distance in pips uses <b>0.01</b> for JPY quotes, <b>0.0001</b> for most FX pairs.
          </div>
        </div>

        <!-- Setup card -->
        <div class="card">
          <h3>Trade Setup</h3>

          <div class="grid2">
            <div>
              <label for="pair">Pair</label>
              <select id="pair" class="field">
                <option>EUR/USD</option><option>GBP/USD</option><option>USD/JPY</option><option>USD/CHF</option><option>USD/CAD</option>
                <option>AUD/USD</option><option>NZD/USD</option><option>EUR/GBP</option><option>EUR/JPY</option><option>GBP/JPY</option>
                <option>GBP/CHF</option><option>GBP/CAD</option><option>AUD/JPY</option><option>CAD/JPY</option>
              </select>
            </div>

            <div>
              <label>Side</label>
              <div class="seg" id="sideSeg">
                <button type="button" data-side="buy" class="active"><i class="fa-solid fa-arrow-trend-up"></i> Buy</button>
                <button type="button" data-side="sell"><i class="fa-solid fa-arrow-trend-down"></i> Sell</button>
              </div>
            </div>

            <div>
              <label for="entry">Entry price</label>
              <input id="entry" class="field" type="text" inputmode="decimal" value="1.1000" />
            </div>

            <div>
              <label for="period">ATR period</label>
              <input id="period" class="field" type="number" min="5" max="50" value="14" />
              <div class="muted" style="margin-top:6px;">Typical: 14. Range: 5–50.</div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <label>ATR multiple</label>
            <div class="chipsRow" id="multChips"></div>
          </div>
        </div>

        <!-- Source card -->
        <div class="card">
          <h3>ATR Source</h3>

          <div class="seg" id="modeSeg">
            <button type="button" data-mode="manual" class="active"><i class="fa-solid fa-pen"></i> Manual ATR</button>
            <button type="button" data-mode="csv"><i class="fa-solid fa-file-csv"></i> Paste candles (CSV)</button>
          </div>

          <div id="manualBlock" style="margin-top:14px;">
            <label for="manualATR">ATR value (price units)</label>
            <input id="manualATR" class="field" type="text" inputmode="decimal" value="0.0100" />
            <div class="muted" style="margin-top:8px;">Example: <b>0.0100</b> for EUR/USD (ATR in price units, not pips).</div>
          </div>

          <div id="csvBlock" style="margin-top:14px; display:none;">
            <label for="csvText">Paste candles (newest last)</label>
            <textarea id="csvText" placeholder="high,low,close
1.1050,1.0980,1.1002
1.1062,1.0991,1.1040

OR time,high,low,close
2025-12-01 10:00,1.1050,1.0980,1.1002"></textarea>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <button id="computeBtn" class="primary" type="button"><i class="fa-solid fa-bolt"></i> Compute ATR from pasted candles</button>
              <div class="muted" id="csvStatus" style="align-self:center;"></div>
            </div>

            <div class="danger" id="csvError"></div>
            <div class="muted" style="margin-top:10px;">
              Accepts columns: <b>high, low, close</b> or <b>time, high, low, close</b>. Date/time optional. Separators: comma, semicolon, or tab.
            </div>
          </div>
        </div>

        <!-- Suggestion card -->
        <div class="card">
          <h3>Suggested Stop</h3>

          <div class="bigBox" id="suggestBox">
            <div>
              <div class="k" id="stopHint">Stop below entry</div>
              <div class="stop" id="stopOut">—</div>
            </div>
            <div class="pips buy" id="pipsOut">— pips</div>
          </div>

          <div class="rows">
            <div class="rowLine"><span>Entry</span><span id="entryOut">—</span></div>
            <div class="rowLine"><span>ATR used</span><span id="atrOut">—</span></div>
            <div class="rowLine"><span>Multiple</span><span id="multOut">—</span></div>
            <div class="rowLine"><span>Pip size</span><span id="pipOut">—</span></div>
          </div>

          <div class="muted" style="margin-top:10px;">
            Formula: <b>stop = entry ± (ATR × multiple)</b>. Pips = <b>|entry − stop| / pipSize</b>.
          </div>
        </div>

      </div>
    </div>
  </main>

  <script>
    const el = {
      pair: document.getElementById("pair"),
      entry: document.getElementById("entry"),
      period: document.getElementById("period"),

      sideSeg: document.getElementById("sideSeg"),
      modeSeg: document.getElementById("modeSeg"),
      multChips: document.getElementById("multChips"),

      manualBlock: document.getElementById("manualBlock"),
      csvBlock: document.getElementById("csvBlock"),
      manualATR: document.getElementById("manualATR"),

      csvText: document.getElementById("csvText"),
      computeBtn: document.getElementById("computeBtn"),
      csvStatus: document.getElementById("csvStatus"),
      csvError: document.getElementById("csvError"),

      pairPill: document.getElementById("pairPill"),
      sidePill: document.getElementById("sidePill"),

      stopHint: document.getElementById("stopHint"),
      stopOut: document.getElementById("stopOut"),
      pipsOut: document.getElementById("pipsOut"),

      entryOut: document.getElementById("entryOut"),
      atrOut: document.getElementById("atrOut"),
      multOut: document.getElementById("multOut"),
      pipOut: document.getElementById("pipOut"),

      tapDismiss: document.getElementById("tapDismiss"),
      suggestBox: document.getElementById("suggestBox"),
    };

    // State (mirrors your Swift defaults)
    const state = {
      sideBuy: true,
      mode: "manual", // "manual" or "csv"
      multipleIndex: 3, // default 2.0x
      multiples: [0.5, 1.0, 1.5, 2.0, 2.5, 3.0],
      lastATRFromCSV: null,
      parsedCount: 0,
    };

    // ===== Utilities =====
    function clampNumber(str){
      const filtered = String(str ?? "").replace(/[^0-9.\-]/g,"");
      let s = filtered;
      const minusCount = (s.match(/\-/g) || []).length;
      if (minusCount > 1) s = s.replace(/\-/g, "");
      if (s.includes("-") && s.indexOf("-") !== 0) s = s.replace(/\-/g,"");
      const parts = s.split(".");
      if (parts.length > 2) s = parts[0] + "." + parts.slice(1).join("");
      return s;
    }
    function parseNum(s){
      const cleaned = String(s ?? "").replaceAll(",", "").replaceAll(" ", "");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }
    function format(n, precision=2){
      const num = Number(n);
      if (!Number.isFinite(num)) return "—";
      return num.toLocaleString(undefined, { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }
    function quoteFromPair(pair){
      // "EUR/USD" => "USD"
      const p = String(pair || "");
      return p.slice(-3);
    }
    function pipSizeForQuote(quote){
      return quote === "JPY" ? 0.01 : 0.0001;
    }
    function suggestedStop(entry, sideBuy, atr, multiple){
      const offset = atr * multiple;
      return sideBuy ? (entry - offset) : (entry + offset);
    }
    function pipsBetween(a, b, pipSize){
      return Math.abs(a - b) / pipSize;
    }

    // ===== CSV Parser (matches your Swift behavior) =====
    function flexDate(s){
      // Not needed for ATR calc, but included for parity.
      // We'll parse ISO / yyyy-MM-dd HH:mm / yyyy-MM-dd loosely.
      const tryIso = new Date(s);
      if (!isNaN(tryIso.getTime())) return tryIso;
      // yyyy-MM-dd HH:mm
      const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
      if (m1){
        const d = new Date(Number(m1[1]), Number(m1[2])-1, Number(m1[3]), Number(m1[4]), Number(m1[5]));
        if (!isNaN(d.getTime())) return d;
      }
      const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m2){
        const d = new Date(Number(m2[1]), Number(m2[2])-1, Number(m2[3]));
        if (!isNaN(d.getTime())) return d;
      }
      return null;
    }

    function parseCSV(text){
      const lines = String(text || "")
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(Boolean);

      if (!lines.length) throw new Error("noRows");

      const first = lines[0].toLowerCase();
      const hasHeader = first.includes("high") || first.includes("close");
      const rows = hasHeader ? lines.slice(1) : lines;

      const out = [];

      for (const r of rows){
        const parts = r.replaceAll(";", ",").replaceAll("\t", ",")
          .split(",")
          .map(x => x.trim());

        // Try time,high,low,close OR high,low,close
        if (parts.length >= 4){
          const dateStr = parts[0];
          const h = parseNum(parts[1]);
          const l = parseNum(parts[2]);
          const c = parseNum(parts[3]);
          if (h == null || l == null || c == null) throw new Error("invalidNumber");
          out.push({ date: flexDate(dateStr), high: h, low: l, close: c });
        } else if (parts.length >= 3){
          const h = parseNum(parts[0]);
          const l = parseNum(parts[1]);
          const c = parseNum(parts[2]);
          if (h == null || l == null || c == null) throw new Error("invalidNumber");
          out.push({ date: null, high: h, low: l, close: c });
        } else {
          throw new Error("invalidNumber");
        }
      }

      return out;
    }

    // Wilder ATR (matches your Swift implementation)
    function wilderATR(candles, period){
      if (!Array.isArray(candles) || candles.length < 2 || !(period > 0)) return [];
      const trs = [];
      for (let i = 1; i < candles.length; i++){
        const h = candles[i].high;
        const l = candles[i].low;
        const prevC = candles[i-1].close;
        const tr = Math.max(h - l, Math.max(Math.abs(h - prevC), Math.abs(l - prevC)));
        trs.push(tr);
      }
      if (trs.length < period) return [];

      const firstSlice = trs.slice(0, period);
      const atr1 = firstSlice.reduce((a,b)=>a+b,0) / period;

      const atrs = [atr1];
      for (let i = period; i < trs.length; i++){
        const prev = atrs[atrs.length - 1];
        const atr = (prev * (period - 1) + trs[i]) / period;
        atrs.push(atr);
      }
      return atrs;
    }

    // ===== UI wiring =====
    function renderMultiples(){
      el.multChips.innerHTML = "";
      state.multiples.forEach((m, idx) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip" + (idx === state.multipleIndex ? " active" : "");
        b.textContent = `${format(m, 1).replace(/\.0$/,"")}×`;
        b.addEventListener("click", () => {
          state.multipleIndex = idx;
          renderMultiples();
          recalcSuggestion();
        });
        el.multChips.appendChild(b);
      });
    }

    function setSide(buy){
      state.sideBuy = !!buy;

      // Seg buttons
      [...el.sideSeg.querySelectorAll("button")].forEach(btn => {
        const isBuy = btn.getAttribute("data-side") === "buy";
        btn.classList.toggle("active", isBuy === state.sideBuy);
      });

      // Pills
      el.sidePill.textContent = state.sideBuy ? "Buy setup" : "Sell setup";
      el.sidePill.className = "pill " + (state.sideBuy ? "buy" : "sell");

      // Suggestion styling
      el.pipsOut.className = "pips " + (state.sideBuy ? "buy" : "sell");
      recalcSuggestion();
    }

    function setMode(mode){
      state.mode = mode;

      [...el.modeSeg.querySelectorAll("button")].forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-mode") === mode);
      });

      el.manualBlock.style.display = (mode === "manual") ? "block" : "none";
      el.csvBlock.style.display = (mode === "csv") ? "block" : "none";

      recalcSuggestion();
    }

    function setCSVError(msg){
      if (msg){
        el.csvError.style.display = "block";
        el.csvError.textContent = msg;
      } else {
        el.csvError.style.display = "none";
        el.csvError.textContent = "";
      }
    }

    function computeFromCSV(){
      setCSVError("");
      el.csvStatus.textContent = "";

      const period = Math.max(1, Math.min(200, parseInt(el.period.value || "14", 10)));
      try{
        const candles = parseCSV(el.csvText.value);
        state.parsedCount = candles.length;
        const series = wilderATR(candles, period);
        const last = series.length ? series[series.length - 1] : null;

        state.lastATRFromCSV = last;
        el.csvStatus.textContent = candles.length
          ? `Parsed ${candles.length} candles. Latest ATR(${period}) = ${last != null ? format(last, 6) : "—"}`
          : "No candles.";

        if (last == null){
          setCSVError(`Not enough rows for ATR(${period}). Need at least ${period + 1} candles (because TR needs previous close).`);
        }
      } catch (e){
        state.lastATRFromCSV = null;
        state.parsedCount = 0;
        if (String(e.message) === "noRows"){
          setCSVError("Paste some rows first.");
        } else if (String(e.message) === "invalidNumber"){
          setCSVError("CSV parse error: invalid number. Use high,low,close or time,high,low,close.");
        } else {
          setCSVError("Failed to parse CSV.");
        }
      } finally {
        recalcSuggestion();
      }
    }

    function recalcSuggestion(){
      const pair = el.pair.value || "EUR/USD";
      el.pairPill.textContent = pair;

      const quote = quoteFromPair(pair);
      const pip = pipSizeForQuote(quote);

      const entry = parseNum(el.entry.value);
      const period = Math.max(1, Math.min(200, parseInt(el.period.value || "14", 10)));
      const multiple = state.multiples[state.multipleIndex];

      // ATR used
      let atr = null;
      if (state.mode === "manual"){
        atr = parseNum(el.manualATR.value);
      } else {
        atr = state.lastATRFromCSV;
      }

      // Fill details rows (even if missing)
      el.entryOut.textContent = (entry != null) ? format(entry, 5) : "—";
      el.multOut.textContent = `${format(multiple, 1).replace(/\.0$/,"")}×`;
      el.pipOut.textContent = (quote === "JPY") ? "0.01 (JPY quote)" : "0.0001 (standard)";
      el.atrOut.textContent = (atr != null) ? `${format(atr, 6)}  (period ${period})` : `—  (period ${period})`;

      // If can't compute yet, show placeholder
      if (entry == null || entry <= 0 || atr == null || atr <= 0){
        el.stopOut.textContent = "—";
        el.pipsOut.textContent = "— pips";
        el.stopHint.textContent = state.sideBuy ? "Stop below entry" : "Stop above entry";
        return;
      }

      const stop = suggestedStop(entry, state.sideBuy, atr, multiple);
      const pips = pipsBetween(entry, stop, pip);

      el.stopHint.textContent = state.sideBuy ? "Stop below entry" : "Stop above entry";
      el.stopOut.textContent = format(stop, 5);
      el.pipsOut.textContent = `${format(pips, 1)} pips`;
    }

    // ===== Input filtering =====
    [el.entry, el.manualATR].forEach(inp => {
      inp.addEventListener("input", () => {
        const c = clampNumber(inp.value);
        if (c !== inp.value) inp.value = c;
        recalcSuggestion();
      });
    });

    el.period.addEventListener("input", () => {
      let v = parseInt(el.period.value || "14", 10);
      if (!Number.isFinite(v)) v = 14;
      v = Math.max(5, Math.min(50, v));
      el.period.value = String(v);
      recalcSuggestion();
    });

    el.pair.addEventListener("change", () => {
      el.pairPill.textContent = el.pair.value;
      recalcSuggestion();
    });

    // Side buttons
    el.sideSeg.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const side = btn.getAttribute("data-side");
      setSide(side === "buy");
    });

    // Mode buttons
    el.modeSeg.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const mode = btn.getAttribute("data-mode");
      setMode(mode === "csv" ? "csv" : "manual");
    });

    // CSV compute
    el.computeBtn.addEventListener("click", computeFromCSV);

    // Tap outside inputs to dismiss
    el.tapDismiss.addEventListener("click", (e) => {
      const t = e.target;
      const isInput = t && (t.tagName === "INPUT" || t.tagName === "TEXTAREA" || t.tagName === "SELECT");
      if (!isInput){
        document.activeElement && document.activeElement.blur && document.activeElement.blur();
      }
    });

    // Build multiples chips
    renderMultiples();

    // Init defaults
    setSide(true);
    setMode("manual");
    recalcSuggestion();
  </script>
</body>
</html>
