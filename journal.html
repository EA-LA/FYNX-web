<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trader Journal ‚Äî FYNX (Live)</title>
  <meta name="description" content="Trader Journal dashboard, analytics, trade replay, streaks, and calendar." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#07080a;
      --bg2:#0b0d11;
      --card:#11141b;
      --card2:#0f1218;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --muted2:rgba(255,255,255,.40);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --r2:14px;
      --sidebar:88px;
      --topbar:64px;
      --good:#46e6a6;
      --bad:#ff4d6d;
      --warn:#f7c948;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(255,255,255,.08), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(255,255,255,.06), transparent 55%),
                  linear-gradient(180deg, var(--bg), #05060a 55%, #040509);
      color:var(--text);
      overflow-x:hidden;
    }

    .bg-grid{
      position:fixed; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 72px 72px;
      opacity:.05;
      pointer-events:none;
      mask-image: radial-gradient(800px 500px at 50% 12%, black 10%, transparent 75%);
    }
    .bg-noise{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.06;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.7' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 260px 260px;
    }
    .bg-sheen{
      position:fixed; inset:-200px -200px auto -200px;
      height:520px;
      background: radial-gradient(closest-side at 40% 40%, rgba(255,255,255,.11), transparent 65%);
      filter: blur(10px);
      pointer-events:none;
      animation: floatSheen 9s ease-in-out infinite;
      opacity:.6;
    }
    @keyframes floatSheen{
      0%,100%{transform: translate3d(0,0,0)}
      50%{transform: translate3d(90px,30px,0)}
    }

    .app{ min-height:100vh; display:flex; }

    .sidebar{
      width:var(--sidebar);
      position:fixed;
      top:0; left:0; bottom:0;
      padding:16px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border-right:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      z-index:30;
    }
    .brand{
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      letter-spacing:.18em;
      font-weight:800;
      font-size:12px;
      color:rgba(255,255,255,.92);
      user-select:none;
    }
    .nav{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .navbtn{
      height:52px;
      border-radius:16px;
      border:1px solid transparent;
      background: transparent;
      color:rgba(255,255,255,.70);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: .18s ease;
      position:relative;
      outline:none;
    }
    .navbtn:hover{ background: rgba(255,255,255,.05); border-color:var(--stroke); }
    .navbtn.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .navbtn span{ font-size:18px; line-height:1; transform: translateY(-1px); }
    .navlabel{
      position:absolute;
      left: 78px;
      white-space:nowrap;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(15,18,24,.92);
      border:1px solid var(--stroke);
      color: rgba(255,255,255,.86);
      font-size:12px;
      opacity:0;
      transform: translateX(-6px);
      pointer-events:none;
      transition:.16s ease;
    }
    .navbtn:hover .navlabel{opacity:1; transform: translateX(0);}
    .sidefoot{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }

    .main{
      margin-left:var(--sidebar);
      width:calc(100% - var(--sidebar));
      min-height:100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      height:var(--topbar);
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 18px;
      background: rgba(7,8,10,.45);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--stroke);
    }
    .title{ display:flex; flex-direction:column; line-height:1.1; }
    .title b{font-size:14px; letter-spacing:.02em}
    .title small{font-size:12px; color:var(--muted)}
    .topbar .right{ margin-left:auto; display:flex; align-items:center; gap:10px; }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      color: rgba(255,255,255,.82);
      font-size:12px;
    }
    .pill input{
      border:none; outline:none;
      background: transparent;
      color: rgba(255,255,255,.82);
      font-size:12px;
      width: 130px;
    }
    .pill select{
      border:none; outline:none;
      background: transparent;
      color: rgba(255,255,255,.82);
      font-size:12px;
      appearance:none;
      cursor:pointer;
    }
    .pill button{
      border:none; outline:none;
      background: transparent;
      color: rgba(255,255,255,.82);
      cursor:pointer;
      font-weight:700;
      letter-spacing:.01em;
    }

    .content{ padding:18px; max-width: 1400px; margin: 0 auto; }

    .grid{ display:grid; gap:14px; }
    .grid.cols-12{ grid-template-columns: repeat(12, minmax(0,1fr)); }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px 10px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd b{ font-size:13px; letter-spacing:.01em; }
    .card .hd small{ color:var(--muted); font-size:12px; }
    .card .bd{ padding:14px 16px 16px 16px; }

    .stat{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:14px 16px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.07);
    }
    .stat small{ color:var(--muted); font-size:12px }
    .stat b{ font-size:22px; letter-spacing:.01em }
    .stat .delta{ font-size:12px; color: var(--muted); display:flex; align-items:center; gap:8px; }
    .good{ color: var(--good) !important; }
    .bad{ color: var(--bad) !important; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px dashed rgba(255,255,255,.08);
    }
    .row:last-child{border-bottom:none}
    .row .l{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .row .l b{font-size:12px; font-weight:700}
    .row .l small{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .row .r{
      font-size:12px;
      color:rgba(255,255,255,.84);
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.80);
      white-space:nowrap;
    }

    .formgrid{ display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:14px; }
    .field{ display:flex; flex-direction:column; gap:8px; }
    label{ font-size:12px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="date"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.90);
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .seg{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .seg button{
      flex:1;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      transition:.16s ease;
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.82);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.14s ease;
    }
    .chip.on{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      letter-spacing:.01em;
      transition:.16s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.12); color: rgba(255,255,255,.82); }
    .btn.danger{ border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.10); }

    .heat{ display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:10px; }
    .day{
      height:54px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .day small{ color: rgba(255,255,255,.55); font-size:11px; }
    .day b{ font-size:12px; }
    .day.pos{ background: rgba(70,230,166,.10); border-color: rgba(70,230,166,.22); }
    .day.neg{ background: rgba(255,77,109,.10); border-color: rgba(255,77,109,.22); }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
      align-items:center;
    }
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid rgba(255,255,255,.14)}
    .dot.pos{ background: rgba(70,230,166,.30); border-color: rgba(70,230,166,.35); }
    .dot.neg{ background: rgba(255,77,109,.30); border-color: rgba(255,77,109,.35); }
    .dot.neu{ background: rgba(255,255,255,.10); }

    section.view{ display:none; }
    section.view.active{ display:block; }

    @media (max-width: 980px){
      .grid.cols-12{ grid-template-columns: repeat(6, minmax(0,1fr)); }
      .main{ width:100%; }
    }
    @media (max-width: 760px){
      :root{ --sidebar: 72px; }
      .topbar .title small{display:none}
      .pill input{ width: 90px; }
      .grid.cols-12{ grid-template-columns: repeat(1, minmax(0,1fr)); }
      .content{ padding:14px; }
    }
  </style>
</head>

<body>
  <div class="bg-sheen"></div>
  <div class="bg-grid"></div>
  <div class="bg-noise"></div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Trader Journal Navigation">
      <div class="brand">FYNX</div>

      <div class="nav">
        <button class="navbtn active" data-view="dash" aria-label="Dashboard">
          <span>‚ñ¶</span><div class="navlabel">Dashboard</div>
        </button>
        <button class="navbtn" data-view="entry" aria-label="New Trade Entry">
          <span>Ôºã</span><div class="navlabel">New Trade Entry</div>
        </button>
        <button class="navbtn" data-view="analytics" aria-label="Performance Analytics">
          <span>‚üê</span><div class="navlabel">Performance Analytics</div>
        </button>
        <button class="navbtn" data-view="replay" aria-label="Trade Replay">
          <span>‚ñ∂</span><div class="navlabel">Trade Replay</div>
        </button>
        <button class="navbtn" data-view="streaks" aria-label="Streaks & Discipline">
          <span>‚ö°</span><div class="navlabel">Streaks & Discipline</div>
        </button>
        <button class="navbtn" data-view="calendar" aria-label="Trading Calendar">
          <span>‚ñ£</span><div class="navlabel">Trading Calendar</div>
        </button>
      </div>

      <div class="sidefoot">
        <button class="navbtn" id="exportBtn" aria-label="Export JSON">
          <span>‚á©</span><div class="navlabel">Export</div>
        </button>
        <a class="navbtn" href="dashboard.html" aria-label="Back to Dashboard" style="text-decoration:none;">
          <span>‚Üê</span><div class="navlabel">Back</div>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="title">
          <b>Trader Journal</b>
          <small>Black & white Grok-style journal UI</small>
        </div>

        <div class="right">
          <div class="pill" title="Date range (visual only)">
            <span style="opacity:.85;">üóì</span>
            <input type="text" value="Last 30 days" aria-label="Date range" />
          </div>
          <div class="pill" title="Account">
            <span style="opacity:.85;">‚óé</span>
            <select aria-label="Account">
              <option>Live</option>
              <option>Demo</option>
              <option>Prop</option>
            </select>
          </div>
          <div class="pill">
            <button id="quickAddBtn" type="button">Quick Add</button>
          </div>
        </div>
      </div>

      <div class="content">

        <!-- DASHBOARD -->
        <section class="view active" id="view-dash">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>Welcome back, Trader</b>
                  <small id="dashSub">Here‚Äôs your performance snapshot</small>
                </div>
                <div class="badge">Journal v1</div>
              </div>

              <div class="bd">
                <div class="grid cols-12">
                  <div class="stat" style="grid-column: span 3;">
                    <small>Total Trades</small>
                    <b id="kpiTrades">0</b>
                    <div class="delta"><span class="badge" id="kpiTradesDelta">‚Äî</span> vs last period</div>
                  </div>

                  <div class="stat" style="grid-column: span 3;">
                    <small>Win Rate</small>
                    <b id="kpiWin">0.0%</b>
                    <div class="delta"><span class="badge" id="kpiWinDelta">‚Äî</span> improvement</div>
                  </div>

                  <div class="stat" style="grid-column: span 3;">
                    <small>Total P/L</small>
                    <b id="kpiPL">+$0</b>
                    <div class="delta"><span class="badge" id="kpiPLDelta">‚Äî</span> realized</div>
                  </div>

                  <div class="stat" style="grid-column: span 3;">
                    <small>Daily Streak</small>
                    <b id="kpiStreak">0</b>
                    <div class="delta"><span class="badge">days</span> logged</div>
                  </div>

                  <div class="card" style="grid-column: span 8;">
                    <div class="hd">
                      <b>Equity Curve</b>
                      <small>Net P/L over time</small>
                    </div>
                    <div class="bd">
                      <canvas id="equityChart" height="120"></canvas>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 4;">
                    <div class="hd">
                      <b>Session Performance</b>
                      <small>Where you win</small>
                    </div>
                    <div class="bd" id="sessionList"></div>
                  </div>

                  <div class="card" style="grid-column: span 6;">
                    <div class="hd">
                      <b>Top Winning Setup</b>
                      <small>Keep repeating what works</small>
                    </div>
                    <div class="bd" id="topSetupList"></div>
                  </div>

                  <div class="card" style="grid-column: span 6;">
                    <div class="hd">
                      <b>Biggest Mistake Pattern</b>
                      <small>What to eliminate</small>
                    </div>
                    <div class="bd" id="mistakePatternList"></div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEW TRADE ENTRY -->
        <section class="view" id="view-entry">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>New Trade Entry</b>
                  <small>Log the trade the same day. Keep it clean.</small>
                </div>
                <div class="actions">
                  <button class="btn ghost" id="resetFormBtn" type="button">Reset</button>
                  <button class="btn" id="saveTradeBtn" type="button">Save Trade</button>
                </div>
              </div>

              <div class="bd">
                <div class="formgrid">
                  <div style="grid-column: span 8;">
                    <div class="grid" style="grid-template-columns: repeat(12, minmax(0,1fr)); gap:14px;">
                      <div class="field" style="grid-column: span 6;">
                        <label>Symbol</label>
                        <input id="fSymbol" type="text" placeholder="EURUSD / XAUUSD / BTCUSD" />
                      </div>

                      <div class="field" style="grid-column: span 6;">
                        <label>Date</label>
                        <input id="fDate" type="date" />
                      </div>

                      <div class="field" style="grid-column: span 12;">
                        <label>Direction</label>
                        <div class="seg" role="group" aria-label="Direction">
                          <button type="button" class="active" data-dir="Long">Long</button>
                          <button type="button" data-dir="Short">Short</button>
                        </div>
                      </div>

                      <div class="field" style="grid-column: span 4;">
                        <label>Entry</label>
                        <input id="fEntry" type="number" step="0.00001" placeholder="0.00000" />
                      </div>
                      <div class="field" style="grid-column: span 4;">
                        <label>Stop Loss</label>
                        <input id="fSL" type="number" step="0.00001" placeholder="0.00000" />
                      </div>
                      <div class="field" style="grid-column: span 4;">
                        <label>Take Profit</label>
                        <input id="fTP" type="number" step="0.00001" placeholder="0.00000" />
                      </div>

                      <div class="field" style="grid-column: span 6;">
                        <label>Setup</label>
                        <select id="fSetup">
                          <option>Break & Retest</option>
                          <option>Liquidity Sweep</option>
                          <option>Trend Pullback</option>
                          <option>Range Fade</option>
                          <option>News / Catalyst</option>
                        </select>
                      </div>

                      <div class="field" style="grid-column: span 6;">
                        <label>Session</label>
                        <select id="fSession">
                          <option>London</option>
                          <option>New York</option>
                          <option>Asia</option>
                          <option>Overlap</option>
                        </select>
                      </div>

                      <div class="field" style="grid-column: span 12;">
                        <label>Reasons / Checklist</label>
                        <div class="chips" id="reasonChips">
                          <div class="chip">HTF Bias</div>
                          <div class="chip">Liquidity</div>
                          <div class="chip">BOS</div>
                          <div class="chip">Pullback</div>
                          <div class="chip">Clean R:R</div>
                          <div class="chip">No News Risk</div>
                          <div class="chip">Asia Liquidity Taken</div>
                          <div class="chip">Time Window</div>
                        </div>
                      </div>

                      <div class="field" style="grid-column: span 12;">
                        <label>Emotion Tags</label>
                        <div class="chips" id="emotionChips">
                          <div class="chip">Calm</div>
                          <div class="chip">Confident</div>
                          <div class="chip">FOMO</div>
                          <div class="chip">Revenge</div>
                          <div class="chip">Hesitant</div>
                          <div class="chip">Overconfident</div>
                        </div>
                      </div>

                      <div class="field" style="grid-column: span 12;">
                        <label>Notes</label>
                        <textarea id="fNotes" placeholder="What was the plan? What did you execute? What would you do differently?"></textarea>
                      </div>
                    </div>
                  </div>

                  <div style="grid-column: span 4;">
                    <div class="card" style="background: rgba(0,0,0,.18); box-shadow:none;">
                      <div class="hd">
                        <b>Quick Stats</b>
                        <small>Auto from entry/SL/TP</small>
                      </div>
                      <div class="bd">
                        <div class="row">
                          <div class="l"><b>Risk (pips/pts)</b><small>Distance to SL</small></div>
                          <div class="r"><span class="badge" id="qRisk">‚Äî</span></div>
                        </div>
                        <div class="row">
                          <div class="l"><b>Reward</b><small>Distance to TP</small></div>
                          <div class="r"><span class="badge" id="qReward">‚Äî</span></div>
                        </div>
                        <div class="row">
                          <div class="l"><b>R:R</b><small>Reward / Risk</small></div>
                          <div class="r"><span class="badge" id="qRR">‚Äî</span></div>
                        </div>
                        <div class="row">
                          <div class="l"><b>Confidence</b><small>Slider</small></div>
                          <div class="r"><span class="badge" id="qConf">70%</span></div>
                        </div>

                        <div class="field" style="margin-top:12px;">
                          <label>Confidence</label>
                          <input id="fConf" type="range" min="0" max="100" value="70" />
                        </div>

                        <div class="field" style="margin-top:12px;">
                          <label>Upload Screenshot</label>
                          <input id="fShot" type="file" accept="image/*" />
                          <div id="shotPreview" style="margin-top:10px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); overflow:hidden; display:none;">
                            <img id="shotImg" alt="Screenshot preview" style="width:100%; display:block;" />
                          </div>
                        </div>

                        <div class="actions" style="margin-top:12px;">
                          <button class="btn ghost" id="goReplayBtn" type="button">Open Replay</button>
                          <button class="btn danger" id="deleteLastBtn" type="button">Delete Last</button>
                        </div>

                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ANALYTICS -->
        <section class="view" id="view-analytics">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>Performance Analytics</b>
                  <small>Trend, sessions, setups, and mistakes</small>
                </div>
                <div class="badge" id="tradeCountBadge">Trades: 0</div>
              </div>

              <div class="bd">
                <div class="grid cols-12">
                  <div class="stat" style="grid-column: span 3;">
                    <small>Avg Win</small>
                    <b id="aWin" class="good">+$0</b>
                    <div class="delta"><span class="badge">per trade</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Avg Loss</small>
                    <b id="aLoss" class="bad">-$0</b>
                    <div class="delta"><span class="badge">per trade</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Expectancy</small>
                    <b id="aExp">+$0</b>
                    <div class="delta"><span class="badge">estimated</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Quality Score</small>
                    <b id="aQual">‚Äî</b>
                    <div class="delta"><span class="badge">rules adherence</span></div>
                  </div>

                  <div class="card" style="grid-column: span 8;">
                    <div class="hd">
                      <b>Win Rate Trend</b>
                      <small>Rolling performance</small>
                    </div>
                    <div class="bd">
                      <canvas id="winTrendChart" height="120"></canvas>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 4;">
                    <div class="hd">
                      <b>P/L by Session</b>
                      <small>Where money is made</small>
                    </div>
                    <div class="bd">
                      <canvas id="sessionPLChart" height="170"></canvas>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 6;">
                    <div class="hd">
                      <b>Setup Performance</b>
                      <small>Top setups by net P/L</small>
                    </div>
                    <div class="bd" id="setupTable"></div>
                  </div>

                  <div class="card" style="grid-column: span 6;">
                    <div class="hd">
                      <b>Mistake Tracker</b>
                      <small>Most frequent rule breaks</small>
                    </div>
                    <div class="bd" id="mistakeList"></div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- REPLAY -->
        <section class="view" id="view-replay">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>Trade Replay</b>
                  <small>Review the last saved trade</small>
                </div>
                <div class="actions">
                  <button class="btn ghost" id="prevTradeBtn" type="button">Previous</button>
                  <button class="btn ghost" id="nextTradeBtn" type="button">Next</button>
                </div>
              </div>
              <div class="bd">
                <div class="grid cols-12">
                  <div class="card" style="grid-column: span 8; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b>Chart Snapshot</b>
                      <small>Screenshot or placeholder</small>
                    </div>
                    <div class="bd">
                      <div id="replayShotBox" style="border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.22); overflow:hidden; min-height:240px; display:flex; align-items:center; justify-content:center;">
                        <div style="text-align:center; color:rgba(255,255,255,.55); font-size:12px; padding:18px;">
                          No screenshot saved for this trade.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 4; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b>Trade Summary</b>
                      <small>Key details</small>
                    </div>
                    <div class="bd" id="replaySummary"></div>
                  </div>

                  <div class="card" style="grid-column: span 12; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b>Replay Notes</b>
                      <small>What happened vs plan</small>
                    </div>
                    <div class="bd">
                      <textarea id="replayNotes" placeholder="Write the replay review here..."></textarea>
                      <div class="actions" style="margin-top:10px;">
                        <button class="btn" id="saveReplayNotesBtn" type="button">Save Replay Notes</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- STREAKS -->
        <section class="view" id="view-streaks">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>Streaks & Discipline</b>
                  <small>Consistency beats intensity</small>
                </div>
                <div class="badge">30-day view</div>
              </div>
              <div class="bd">
                <div class="grid cols-12">
                  <div class="stat" style="grid-column: span 3;">
                    <small>Streak</small>
                    <b id="sStreak">0 Days</b>
                    <div class="delta"><span class="badge">current</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Rules Followed</small>
                    <b id="sRules">0%</b>
                    <div class="delta"><span class="badge">avg</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Emotional Control</small>
                    <b id="sEmotion">0/100</b>
                    <div class="delta"><span class="badge">score</span></div>
                  </div>
                  <div class="stat" style="grid-column: span 3;">
                    <small>Consistency</small>
                    <b id="sCons">0/30</b>
                    <div class="delta"><span class="badge">days logged</span></div>
                  </div>

                  <div class="card" style="grid-column: span 8;">
                    <div class="hd">
                      <b>Emotional Control Trend</b>
                      <small>Keep it stable</small>
                    </div>
                    <div class="bd">
                      <canvas id="emotionChart" height="120"></canvas>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 4;">
                    <div class="hd">
                      <b>Discipline Profile</b>
                      <small>Radar</small>
                    </div>
                    <div class="bd">
                      <canvas id="disciplineChart" height="190"></canvas>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 12;">
                    <div class="hd">
                      <b>30-Day Consistency</b>
                      <small>Green = logged day</small>
                    </div>
                    <div class="bd">
                      <div class="heat" id="consistencyHeat"></div>
                      <div style="height:10px"></div>
                      <div class="legend">
                        <span class="dot neu"></span> no log
                        <span style="width:12px"></span>
                        <span class="dot pos"></span> logged
                      </div>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 12;">
                    <div class="hd">
                      <b>Achievements & Badges</b>
                      <small>Progress rewards</small>
                    </div>
                    <div class="bd" style="display:flex; gap:12px; flex-wrap:wrap;">
                      <span class="badge">7-day streak</span>
                      <span class="badge">No revenge trades (7d)</span>
                      <span class="badge">Perfect checklist (x10)</span>
                      <span class="badge">+3R hit</span>
                      <span class="badge">Journal discipline</span>
                      <span class="badge">Calm executor</span>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CALENDAR -->
        <section class="view" id="view-calendar">
          <div class="grid cols-12">
            <div class="card" style="grid-column: span 12;">
              <div class="hd">
                <div>
                  <b>Trading Calendar</b>
                  <small>Daily profit/loss heatmap</small>
                </div>
                <div class="legend">
                  <span class="dot pos"></span> profit
                  <span class="dot neg"></span> loss
                  <span class="dot neu"></span> flat
                </div>
              </div>

              <div class="bd">
                <div class="grid cols-12">
                  <div class="card" style="grid-column: span 8; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b id="calTitle">Month</b>
                      <small id="calSub">Month view</small>
                    </div>
                    <div class="bd">
                      <div class="heat" id="calendarHeat"></div>
                    </div>
                  </div>

                  <div class="card" style="grid-column: span 4; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b>Monthly Summary</b>
                      <small>Totals & notes</small>
                    </div>
                    <div class="bd" id="monthSummary"></div>
                  </div>

                  <div class="card" style="grid-column: span 12; background: rgba(0,0,0,.18); box-shadow:none;">
                    <div class="hd">
                      <b>Day Details</b>
                      <small>Tap a day on the calendar</small>
                    </div>
                    <div class="bd" id="dayDetails">
                      <div style="color:rgba(255,255,255,.58); font-size:12px;">Select a day to view details.</div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Firebase (LIVE) -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-storage-compat.js"></script>

  <script>
    // ====== IMPORTANT ======
    // If your login page file name is different, change this:
    const LOGIN_URL = "login.html";

    // Your Firebase config (you provided this)
    const firebaseConfig = {
      apiKey: "AIzaSyDGSYIB_YIpbWyUMJ1d-v00-xADnvaWckk",
      authDomain: "fynx-c7a28.firebaseapp.com",
      databaseURL: "https://fynx-c7a28-default-rtdb.firebaseio.com",
      projectId: "fynx-c7a28",
      storageBucket: "fynx-c7a28.firebasestorage.app",
      messagingSenderId: "1011050657868",
      appId: "1:1011050657868:web:2c5ad5a1b275e669b05ce9",
      measurementId: "G-SDW6273VYJ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let state = { trades: [] };
    let replayIndex = 0;
    let currentUid = null;
    let unsubTrades = null;

    // Require login for this page (PRIVATE)
    auth.onAuthStateChanged((user) => {
      if (!user) {
        location.href = LOGIN_URL;
        return;
      }
      currentUid = user.uid;
      bootLive();
    });

    const tradesCol = () => db.collection("users").doc(currentUid).collection("trades");

    function bootLive() {
      // ---------- Navigation ----------
      const navBtns = [...document.querySelectorAll(".navbtn[data-view]")];
      const views = {
        dash: document.getElementById("view-dash"),
        entry: document.getElementById("view-entry"),
        analytics: document.getElementById("view-analytics"),
        replay: document.getElementById("view-replay"),
        streaks: document.getElementById("view-streaks"),
        calendar: document.getElementById("view-calendar")
      };

      const setActiveView = (key) => {
        navBtns.forEach(b => b.classList.toggle("active", b.dataset.view === key));
        Object.entries(views).forEach(([k, el]) => el.classList.toggle("active", k === key));
        if(key === "analytics") refreshAnalytics();
        if(key === "replay") refreshReplay();
        if(key === "streaks") refreshStreaks();
        if(key === "calendar") refreshCalendar();
        if(key === "dash") refreshDashboard();
      };

      navBtns.forEach(btn => btn.addEventListener("click", () => setActiveView(btn.dataset.view)));
      document.getElementById("quickAddBtn").addEventListener("click", () => setActiveView("entry"));
      document.getElementById("goReplayBtn").addEventListener("click", () => setActiveView("replay"));

      // ---------- Charts ----------
      const mkChartDefaults = () => ({
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ labels:{ color:"rgba(255,255,255,.72)", font:{ size:11 } } },
          tooltip:{ enabled:true }
        },
        scales:{
          x:{ ticks:{ color:"rgba(255,255,255,.55)", font:{ size:11 } }, grid:{ color:"rgba(255,255,255,.07)" } },
          y:{ ticks:{ color:"rgba(255,255,255,.55)", font:{ size:11 } }, grid:{ color:"rgba(255,255,255,.07)" } }
        }
      });

      let equityChart, winTrendChart, sessionPLChart, emotionChart, disciplineChart;

      const initCharts = () => {
        equityChart = new Chart(document.getElementById("equityChart"), {
          type:"line",
          data:{ labels:[], datasets:[{
            label:"Equity",
            data:[],
            borderColor:"rgba(255,255,255,.85)",
            backgroundColor:"rgba(255,255,255,.08)",
            fill:true,
            tension:.35,
            pointRadius:0
          }]},
          options: mkChartDefaults()
        });

        winTrendChart = new Chart(document.getElementById("winTrendChart"), {
          type:"line",
          data:{ labels:[], datasets:[{
            label:"Win Rate % (rolling)",
            data:[],
            borderColor:"rgba(255,255,255,.85)",
            backgroundColor:"rgba(255,255,255,.08)",
            fill:true,
            tension:.35,
            pointRadius:0
          }]},
          options: mkChartDefaults()
        });

        sessionPLChart = new Chart(document.getElementById("sessionPLChart"), {
          type:"bar",
          data:{ labels:["London","New York","Asia","Overlap"], datasets:[{
            label:"Net P/L",
            data:[0,0,0,0],
            borderColor:"rgba(255,255,255,.85)",
            backgroundColor:"rgba(255,255,255,.14)"
          }]},
          options: mkChartDefaults()
        });

        emotionChart = new Chart(document.getElementById("emotionChart"), {
          type:"line",
          data:{ labels:[], datasets:[{
            label:"Control Score (proxy)",
            data:[],
            borderColor:"rgba(255,255,255,.85)",
            backgroundColor:"rgba(255,255,255,.08)",
            fill:true,
            tension:.35,
            pointRadius:0
          }]},
          options: mkChartDefaults()
        });

        disciplineChart = new Chart(document.getElementById("disciplineChart"), {
          type:"radar",
          data:{
            labels:["Rules","Timing","Risk","Patience","Journal","Focus"],
            datasets:[{
              label:"Discipline",
              data:[0,0,0,0,0,0],
              borderColor:"rgba(255,255,255,.85)",
              backgroundColor:"rgba(255,255,255,.10)",
              pointBackgroundColor:"rgba(255,255,255,.85)",
              pointRadius:2
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ labels:{ color:"rgba(255,255,255,.72)", font:{ size:11 } } } },
            scales:{
              r:{
                grid:{ color:"rgba(255,255,255,.10)" },
                angleLines:{ color:"rgba(255,255,255,.10)" },
                pointLabels:{ color:"rgba(255,255,255,.70)", font:{ size:11 } },
                ticks:{ display:false }
              }
            }
          }
        });
      };

      const updateCharts = () => {
        const trades = [...state.trades].sort((a,b) => (a.dateTsMs||0) - (b.dateTsMs||0));

        const labels = [];
        const data = [];
        let cum = 0;
        trades.forEach(t => {
          labels.push(String(t.date || "").slice(5) || "‚Äî");
          cum += (t.pl || 0);
          data.push(Number(cum.toFixed(2)));
        });
        equityChart.data.labels = labels;
        equityChart.data.datasets[0].data = data;
        equityChart.update();

        const wlabels = [];
        const wdata = [];
        const window = 10;
        for (let i=0;i<trades.length;i++){
          const start = Math.max(0, i-window+1);
          const slice = trades.slice(start, i+1);
          const wins = slice.filter(x => (x.pl||0) > 0).length;
          const wr = slice.length ? (wins/slice.length)*100 : 0;
          wlabels.push(String(trades[i].date||"").slice(5) || "‚Äî");
          wdata.push(Number(wr.toFixed(1)));
        }
        winTrendChart.data.labels = wlabels;
        winTrendChart.data.datasets[0].data = wdata;
        winTrendChart.update();

        const sessions = { "London":0, "New York":0, "Asia":0, "Overlap":0 };
        state.trades.forEach(t => { sessions[t.session] = (sessions[t.session]||0) + (t.pl||0); });
        sessionPLChart.data.datasets[0].data = [
          sessions["London"]||0,
          sessions["New York"]||0,
          sessions["Asia"]||0,
          sessions["Overlap"]||0
        ].map(x => Number(x.toFixed(2)));
        sessionPLChart.update();

        const emoLabels = [];
        const emoData = [];
        trades.slice(-12).forEach(t => {
          const reasons = (t.reasons||[]).length;
          const control = Math.min(100, Math.max(0, 60 + reasons*5 - (t.emotions||[]).includes("Revenge")*15 - (t.emotions||[]).includes("FOMO")*10));
          emoLabels.push(String(t.date||"").slice(5) || "‚Äî");
          emoData.push(control);
        });
        emotionChart.data.labels = emoLabels;
        emotionChart.data.datasets[0].data = emoData;
        emotionChart.update();

        const total = state.trades.length || 1;
        const avgReasons = state.trades.reduce((a,t)=>a+(t.reasons||[]).length,0)/total;
        const rules = Math.min(100, Math.round(avgReasons*10));
        const timing = Math.min(100, 60 + Math.round((state.trades.filter(t=>t.session==="London"||t.session==="Overlap").length/total)*40));
        const risk = Math.min(100, 65 + Math.round((state.trades.filter(t=>(t.conf||0)>=70).length/total)*35));
        const patience = Math.min(100, 55 + Math.round((state.trades.filter(t=>(t.emotions||[]).includes("Hesitant")).length/total)*10));
        const journal = Math.min(100, 50 + Math.round((state.trades.filter(t=>(t.notes||"").trim().length>20).length/total)*50));
        const focus = Math.min(100, 55 + Math.round((state.trades.filter(t=>!(t.emotions||[]).includes("Overconfident")).length/total)*45));
        disciplineChart.data.datasets[0].data = [rules,timing,risk,patience,journal,focus];
        disciplineChart.update();
      };

      // ---------- Entry form ----------
      const dirSeg = document.querySelectorAll(".seg button");
      let direction = "Long";
      dirSeg.forEach(b => b.addEventListener("click", () => {
        dirSeg.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        direction = b.dataset.dir;
      }));

      const toggleChipGroup = (id) => {
        const wrap = document.getElementById(id);
        wrap.querySelectorAll(".chip").forEach(ch => ch.addEventListener("click", () => ch.classList.toggle("on")));
      };
      toggleChipGroup("reasonChips");
      toggleChipGroup("emotionChips");

      const fEntry = document.getElementById("fEntry");
      const fSL = document.getElementById("fSL");
      const fTP = document.getElementById("fTP");
      const fConf = document.getElementById("fConf");
      const qRisk = document.getElementById("qRisk");
      const qReward = document.getElementById("qReward");
      const qRR = document.getElementById("qRR");
      const qConf = document.getElementById("qConf");

      const calcStats = () => {
        const e = parseFloat(fEntry.value);
        const sl = parseFloat(fSL.value);
        const tp = parseFloat(fTP.value);

        qConf.textContent = `${fConf.value}%`;

        if(!isFinite(e) || !isFinite(sl) || !isFinite(tp)){
          qRisk.textContent = "‚Äî";
          qReward.textContent = "‚Äî";
          qRR.textContent = "‚Äî";
          return;
        }

        const risk = Math.abs(e - sl);
        const reward = Math.abs(tp - e);
        const rr = risk > 0 ? (reward / risk) : 0;

        qRisk.textContent = risk.toFixed(2);
        qReward.textContent = reward.toFixed(2);
        qRR.textContent = rr.toFixed(2);
      };
      [fEntry,fSL,fTP,fConf].forEach(el => el.addEventListener("input", calcStats));

      // Screenshot preview + upload
      const fShot = document.getElementById("fShot");
      const shotPreview = document.getElementById("shotPreview");
      const shotImg = document.getElementById("shotImg");
      let shotFile = null;

      fShot.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file){ shotFile=null; shotPreview.style.display="none"; return; }
        shotFile = file;
        const reader = new FileReader();
        reader.onload = () => { shotImg.src = String(reader.result || ""); shotPreview.style.display = "block"; };
        reader.readAsDataURL(file);
      });

      const getChips = (id) =>
        [...document.querySelectorAll(`#${id} .chip.on`)].map(c => c.textContent.trim());

      const saveTradeBtn = document.getElementById("saveTradeBtn");
      const resetFormBtn = document.getElementById("resetFormBtn");
      const deleteLastBtn = document.getElementById("deleteLastBtn");

      const clearForm = () => {
        document.getElementById("fSymbol").value = "";
        document.getElementById("fDate").valueAsDate = new Date();
        fEntry.value = "";
        fSL.value = "";
        fTP.value = "";
        document.getElementById("fSetup").selectedIndex = 0;
        document.getElementById("fSession").selectedIndex = 0;
        document.getElementById("fNotes").value = "";
        fConf.value = 70;
        qConf.textContent = "70%";
        shotFile = null;
        fShot.value = "";
        shotPreview.style.display = "none";
        document.querySelectorAll(".chip.on").forEach(x => x.classList.remove("on"));
        calcStats();
      };
      resetFormBtn.addEventListener("click", clearForm);

      const estimatePL = (entry, tp, sl) => {
        const e = parseFloat(entry), T = parseFloat(tp), S = parseFloat(sl);
        if(!isFinite(e) || !isFinite(T) || !isFinite(S)) return 0;
        const reward = Math.abs(T - e);
        const risk = Math.abs(e - S);
        return (reward - (risk * 0.4)); // proxy until you replace with real P/L logic
      };

      async function uploadScreenshotIfAny(tradeId) {
        if(!shotFile) return "";
        const path = `users/${currentUid}/trades/${tradeId}/screenshot_${Date.now()}.jpg`;
        const ref = storage.ref().child(path);
        await ref.put(shotFile, { contentType: shotFile.type || "image/jpeg" });
        return await ref.getDownloadURL();
      }

      saveTradeBtn.addEventListener("click", async () => {
        try{
          saveTradeBtn.disabled = true;

          const symbol = document.getElementById("fSymbol").value.trim() || "‚Äî";
          const date = document.getElementById("fDate").value || new Date().toISOString().slice(0,10);
          const entry = document.getElementById("fEntry").value;
          const sl = document.getElementById("fSL").value;
          const tp = document.getElementById("fTP").value;
          const setup = document.getElementById("fSetup").value;
          const session = document.getElementById("fSession").value;
          const reasons = getChips("reasonChips");
          const emotions = getChips("emotionChips");
          const notes = document.getElementById("fNotes").value.trim();
          const conf = parseInt(document.getElementById("fConf").value, 10) || 0;

          const pl = estimatePL(entry, tp, sl);
          const tradeId = crypto.randomUUID();
          const dateTs = firebase.firestore.Timestamp.fromDate(new Date(date + "T00:00:00"));

          const screenshotUrl = await uploadScreenshotIfAny(tradeId);

          const tradeDoc = {
            id: tradeId,
            symbol, date, direction,
            entry, sl, tp,
            setup, session,
            reasons, emotions,
            notes, conf,
            screenshot: screenshotUrl || "",
            pl: Number.isFinite(pl) ? pl : 0,
            dateTs,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          await tradesCol().doc(tradeId).set(tradeDoc, { merge:false });

          clearForm();
          setActiveView("replay");
        } catch(err){
          console.error(err);
          alert("Save failed. Check Firestore + Storage rules.");
        } finally {
          saveTradeBtn.disabled = false;
        }
      });

      deleteLastBtn.addEventListener("click", async () => {
        if(state.trades.length === 0) return;
        const t = state.trades[state.trades.length - 1];
        try{
          await tradesCol().doc(t.id).delete();
        } catch(err){
          console.error(err);
          alert("Delete failed. Check Firestore rules.");
        }
      });

      // ---------- Analytics ----------
      const refreshAnalytics = () => {
        document.getElementById("tradeCountBadge").textContent = `Trades: ${state.trades.length}`;
        if(state.trades.length === 0){
          document.getElementById("aWin").textContent = "+$0";
          document.getElementById("aLoss").textContent = "-$0";
          document.getElementById("aExp").textContent = "+$0";
          document.getElementById("aQual").textContent = "‚Äî";
          document.getElementById("setupTable").innerHTML =
            `<div style="color:rgba(255,255,255,.58); font-size:12px;">No trades yet. Add trades to see analytics.</div>`;
          document.getElementById("mistakeList").innerHTML =
            `<div style="color:rgba(255,255,255,.58); font-size:12px;">No data yet.</div>`;
          return;
        }

        const pls = state.trades.map(t => t.pl || 0);
        const wins = pls.filter(x => x > 0);
        const losses = pls.filter(x => x < 0);

        const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
        const avgWin = avg(wins);
        const avgLoss = avg(losses);

        document.getElementById("aWin").textContent = `+$${Math.abs(avgWin).toFixed(0)}`;
        document.getElementById("aLoss").textContent = `-$${Math.abs(avgLoss).toFixed(0)}`;

        const winRate = wins.length / state.trades.length;
        const expectancy = (winRate * avgWin) + ((1-winRate) * avgLoss);
        const expEl = document.getElementById("aExp");
        expEl.textContent = `${expectancy >= 0 ? "+" : "-"}$${Math.abs(expectancy).toFixed(0)}`;
        expEl.className = expectancy >= 0 ? "good" : "bad";

        const reasonCount = state.trades.map(t => (t.reasons||[]).length);
        const q = Math.round(avg(reasonCount) * 12);
        document.getElementById("aQual").textContent = `${Math.min(100, Math.max(0,q))}/100`;

        const bySetup = {};
        state.trades.forEach(t => { bySetup[t.setup] = (bySetup[t.setup] || 0) + (t.pl || 0); });
        document.getElementById("setupTable").innerHTML = Object.entries(bySetup)
          .sort((a,b)=> b[1]-a[1])
          .slice(0,6)
          .map(([name, val]) => {
            const cls = val >= 0 ? "good" : "bad";
            return `
              <div class="row">
                <div class="l"><b>${escapeHtml(name)}</b><small>Net P/L</small></div>
                <div class="r"><span class="badge ${cls}">${val>=0?"+":"-"}$${Math.abs(val).toFixed(0)}</span></div>
              </div>`;
          }).join("");

        const mistakeBuckets = {};
        state.trades.forEach(t => { (t.emotions||[]).forEach(e => mistakeBuckets[e] = (mistakeBuckets[e]||0)+1); });
        const mistakes = Object.entries(mistakeBuckets).sort((a,b)=>b[1]-a[1]).slice(0,6);
        document.getElementById("mistakeList").innerHTML = mistakes.length ? mistakes.map(([m,c]) => `
          <div class="row">
            <div class="l"><b>${escapeHtml(m)}</b><small>Occurrences</small></div>
            <div class="r"><span class="badge">${c}</span></div>
          </div>
        `).join("") : `<div style="color:rgba(255,255,255,.58); font-size:12px;">No mistake tags yet.</div>`;
      };

      // ---------- Replay ----------
      const replaySummary = document.getElementById("replaySummary");
      const replayShotBox = document.getElementById("replayShotBox");
      const replayNotes = document.getElementById("replayNotes");

      const refreshReplay = () => {
        if(state.trades.length === 0){
          replaySummary.innerHTML = `<div style="color:rgba(255,255,255,.58); font-size:12px;">No trades saved yet. Use ‚ÄúNew Trade Entry‚Äù.</div>`;
          replayShotBox.innerHTML = `<div style="text-align:center; color:rgba(255,255,255,.55); font-size:12px; padding:18px;">No trade selected.</div>`;
          replayNotes.value = "";
          return;
        }
        replayIndex = Math.max(0, Math.min(replayIndex, state.trades.length - 1));
        const t = state.trades[replayIndex];

        const pl = t.pl || 0;
        const cls = pl >= 0 ? "good" : "bad";

        replaySummary.innerHTML = `
          <div class="row">
            <div class="l"><b>${escapeHtml(t.symbol)}</b><small>${escapeHtml(t.date)}</small></div>
            <div class="r"><span class="badge ${cls}">${pl>=0?"+":"-"}$${Math.abs(pl).toFixed(0)}</span></div>
          </div>
          <div class="row"><div class="l"><b>Direction</b><small>${escapeHtml(t.direction)}</small></div><div class="r"><span class="badge">${escapeHtml(t.session)}</span></div></div>
          <div class="row"><div class="l"><b>Setup</b><small>${escapeHtml(t.setup)}</small></div><div class="r"><span class="badge">${escapeHtml(String(t.conf||0))}%</span></div></div>
          <div class="row"><div class="l"><b>Entry</b><small>${escapeHtml(String(t.entry||"‚Äî"))}</small></div><div class="r"><span class="badge">SL ${escapeHtml(String(t.sl||"‚Äî"))}</span></div></div>
          <div class="row"><div class="l"><b>TP</b><small>${escapeHtml(String(t.tp||"‚Äî"))}</small></div><div class="r"><span class="badge">ID</span></div></div>
        `;

        if(t.screenshot){
          replayShotBox.innerHTML = `<img alt="Trade screenshot" src="${t.screenshot}" style="width:100%; display:block;" />`;
        } else {
          replayShotBox.innerHTML = `<div style="text-align:center; color:rgba(255,255,255,.55); font-size:12px; padding:18px;">No screenshot saved for this trade.</div>`;
        }

        replayNotes.value = String(t.replayNotes || "");
      };

      document.getElementById("prevTradeBtn").addEventListener("click", () => {
        if(state.trades.length === 0) return;
        replayIndex = Math.max(0, replayIndex - 1);
        refreshReplay();
      });
      document.getElementById("nextTradeBtn").addEventListener("click", () => {
        if(state.trades.length === 0) return;
        replayIndex = Math.min(state.trades.length - 1, replayIndex + 1);
        refreshReplay();
      });

      document.getElementById("saveReplayNotesBtn").addEventListener("click", async () => {
        if(state.trades.length === 0) return;
        const t = state.trades[replayIndex];
        try{
          await tradesCol().doc(t.id).set({ replayNotes: replayNotes.value }, { merge:true });
        } catch(err){
          console.error(err);
          alert("Replay notes save failed. Check Firestore rules.");
        }
      });

      // ---------- Streaks ----------
      const refreshStreaks = () => {
        const dates = [...new Set(state.trades.map(t => t.date).filter(Boolean))].sort();
        let streak = 0;
        if(dates.length){
          const today = new Date(); today.setHours(0,0,0,0);
          const dateSet = new Set(dates);
          while(true){
            const d = new Date(today);
            d.setDate(d.getDate() - streak);
            const iso = d.toISOString().slice(0,10);
            if(dateSet.has(iso)) streak++;
            else break;
          }
        }

        document.getElementById("sStreak").textContent = `${Math.max(0, streak)} Days`;

        const avgReasons = state.trades.length ? state.trades.reduce((a,t)=>a+(t.reasons||[]).length,0)/state.trades.length : 0;
        const rules = Math.min(100, Math.round(avgReasons * 10));
        document.getElementById("sRules").textContent = `${rules}%`;

        const control = Math.min(100, Math.max(0, 70 + Math.round((rules-50)/2)));
        document.getElementById("sEmotion").textContent = `${control}/100`;

        const logged = [...new Set(state.trades.map(t => t.date).filter(Boolean))].length;
        document.getElementById("sCons").textContent = `${Math.min(30, logged)}/30`;

        const heat = document.getElementById("consistencyHeat");
        heat.innerHTML = "";
        const today = new Date(); today.setHours(0,0,0,0);
        const loggedSet = new Set(state.trades.map(t => t.date).filter(Boolean));
        for(let i=29;i>=0;i--){
          const d = new Date(today);
          d.setDate(d.getDate()-i);
          const iso = d.toISOString().slice(0,10);
          const cell = document.createElement("div");
          cell.className = "day " + (loggedSet.has(iso) ? "pos" : "");
          cell.innerHTML = `<small>${iso.slice(5)}</small><b>${loggedSet.has(iso) ? "Logged" : ""}</b>`;
          heat.appendChild(cell);
        }
      };

      // ---------- Calendar ----------
      const refreshCalendar = () => {
        const calendarHeat = document.getElementById("calendarHeat");
        const monthSummary = document.getElementById("monthSummary");
        const dayDetails = document.getElementById("dayDetails");
        calendarHeat.innerHTML = "";

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const monthName = today.toLocaleString(undefined, { month:"long" });
        document.getElementById("calTitle").textContent = monthName;
        document.getElementById("calSub").textContent = `${year}`;

        const plByDate = {};
        state.trades.forEach(t => {
          const dt = t.date;
          if(!dt) return;
          plByDate[dt] = (plByDate[dt]||0) + (t.pl||0);
        });

        const first = new Date(year, month, 1);
        const startDow = first.getDay();
        const last = new Date(year, month+1, 0);
        const daysInMonth = last.getDate();

        const totalCells = 42;
        for(let i=0;i<totalCells;i++){
          const dayNum = i - startDow + 1;
          const cell = document.createElement("div");
          cell.className = "day";
          if(dayNum < 1 || dayNum > daysInMonth){
            cell.style.opacity = ".35";
            cell.innerHTML = `<small>‚Äî</small><b></b>`;
            calendarHeat.appendChild(cell);
            continue;
          }
          const iso = new Date(year, month, dayNum).toISOString().slice(0,10);
          const pl = plByDate[iso] || 0;
          if(pl > 0) cell.classList.add("pos");
          if(pl < 0) cell.classList.add("neg");
          cell.innerHTML = `<small>${dayNum}</small><b>${pl === 0 ? "" : (pl>0?"+":"-") + "$" + Math.abs(pl).toFixed(0)}</b>`;
          cell.style.cursor = "pointer";
          cell.addEventListener("click", () => {
            const trades = state.trades.filter(t => t.date === iso);
            if(!trades.length){
              dayDetails.innerHTML = `<div style="color:rgba(255,255,255,.58); font-size:12px;">No trades on ${escapeHtml(iso)}.</div>`;
              return;
            }
            dayDetails.innerHTML = trades.map(t => {
              const pl = t.pl || 0;
              const cls = pl >= 0 ? "good" : "bad";
              return `
                <div class="row">
                  <div class="l">
                    <b>${escapeHtml(t.symbol)} ¬∑ ${escapeHtml(t.setup)}</b>
                    <small>${escapeHtml(t.session)} ¬∑ ${escapeHtml(t.direction)} ¬∑ ${escapeHtml(String(t.conf||0))}%</small>
                  </div>
                  <div class="r"><span class="badge ${cls}">${pl>=0?"+":"-"}$${Math.abs(pl).toFixed(0)}</span></div>
                </div>`;
            }).join("");
          });
          calendarHeat.appendChild(cell);
        }

        const monthTrades = state.trades.filter(t => {
          if(!t.date) return false;
          const d = new Date(t.date+"T00:00:00");
          return d.getFullYear() === year && d.getMonth() === month;
        });

        const monthPL = monthTrades.reduce((a,t)=>a+(t.pl||0),0);
        const wins = monthTrades.filter(t => (t.pl||0) > 0).length;
        const total = monthTrades.length;
        const wr = total ? (wins/total)*100 : 0;

        const cls = monthPL >= 0 ? "good" : "bad";

        monthSummary.innerHTML = `
          <div class="row"><div class="l"><b>Net P/L</b><small>This month</small></div><div class="r"><span class="badge ${cls}">${monthPL>=0?"+":"-"}$${Math.abs(monthPL).toFixed(0)}</span></div></div>
          <div class="row"><div class="l"><b>Trades</b><small>Total</small></div><div class="r"><span class="badge">${total}</span></div></div>
          <div class="row"><div class="l"><b>Win Rate</b><small>Estimated</small></div><div class="r"><span class="badge">${wr.toFixed(1)}%</span></div></div>
          <div class="row"><div class="l"><b>Notes</b><small>Focus area</small></div><div class="r"><span class="badge">Patience</span></div></div>
        `;
      };

      // ---------- Dashboard ----------
      function refreshDashboard() {
        const total = state.trades.length;
        document.getElementById("kpiTrades").textContent = String(total);

        const wins = state.trades.filter(t => (t.pl||0) > 0).length;
        const wr = total ? (wins/total)*100 : 0;
        document.getElementById("kpiWin").textContent = `${wr.toFixed(1)}%`;

        const totalPL = state.trades.reduce((a,t)=>a+(t.pl||0),0);
        const kpiPL = document.getElementById("kpiPL");
        kpiPL.textContent = `${totalPL>=0?"+":"-"}$${Math.abs(totalPL).toFixed(0)}`;
        kpiPL.className = totalPL >= 0 ? "good" : "bad";

        const dates = [...new Set(state.trades.map(t => t.date).filter(Boolean))].sort();
        let streak = 0;
        if(dates.length){
          const today = new Date(); today.setHours(0,0,0,0);
          const set = new Set(dates);
          while(true){
            const d = new Date(today);
            d.setDate(d.getDate() - streak);
            const iso = d.toISOString().slice(0,10);
            if(set.has(iso)) streak++;
            else break;
          }
        }
        document.getElementById("kpiStreak").textContent = String(streak);

        const bySession = {};
        state.trades.forEach(t => bySession[t.session] = (bySession[t.session]||0) + (t.pl||0));
        const sessionOrder = ["London","New York","Asia","Overlap"];
        document.getElementById("sessionList").innerHTML = sessionOrder.map(name => {
          const val = bySession[name] || 0;
          const cls = val >= 0 ? "good" : "bad";
          const sub =
            name==="London" ? "Highest consistency" :
            name==="New York" ? "High volatility" :
            name==="Asia" ? "Lower frequency" :
            "Best R:R setups";
          return `
            <div class="row">
              <div class="l"><b>${escapeHtml(name)}</b><small>${escapeHtml(sub)}</small></div>
              <div class="r"><span class="badge ${cls}">${val>=0?"+":"-"}$${Math.abs(val).toFixed(0)}</span></div>
            </div>`;
        }).join("") || `<div style="color:rgba(255,255,255,.58); font-size:12px;">No data yet.</div>`;

        const bySetup = {};
        state.trades.forEach(t => bySetup[t.setup] = (bySetup[t.setup]||0) + (t.pl||0));
        const topSetups = Object.entries(bySetup).sort((a,b)=>b[1]-a[1]).slice(0,3);
        document.getElementById("topSetupList").innerHTML = topSetups.length ? topSetups.map(([name,val]) => {
          const cls = val >= 0 ? "good" : "bad";
          return `
            <div class="row">
              <div class="l"><b>${escapeHtml(name)}</b><small>Net P/L</small></div>
              <div class="r"><span class="badge ${cls}">${val>=0?"+":"-"}$${Math.abs(val).toFixed(0)}</span></div>
            </div>`;
        }).join("") : `<div style="color:rgba(255,255,255,.58); font-size:12px;">No setups logged yet.</div>`;

        const bucket = {};
        state.trades.forEach(t => (t.emotions||[]).forEach(e => bucket[e] = (bucket[e]||0) + 1));
        const topMistakes = Object.entries(bucket).sort((a,b)=>b[1]-a[1]).slice(0,3);
        document.getElementById("mistakePatternList").innerHTML = topMistakes.length ? topMistakes.map(([m,c]) => `
          <div class="row">
            <div class="l"><b>${escapeHtml(m)}</b><small>Occurrences</small></div>
            <div class="r"><span class="badge">${c}</span></div>
          </div>
        `).join("") : `<div style="color:rgba(255,255,255,.58); font-size:12px;">No mistake tags yet.</div>`;
      }

      // ---------- Export ----------
      document.getElementById("exportBtn").addEventListener("click", () => {
        const data = JSON.stringify({ trades: state.trades }, null, 2);
        const blob = new Blob([data], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "trader-journal-export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, s => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[s]));
      }

      // ---------- Firestore sync ----------
      function attachTradesListener() {
        if (unsubTrades) unsubTrades();

        unsubTrades = tradesCol()
          .orderBy("dateTs", "asc")
          .onSnapshot((snap) => {
            const trades = [];
            snap.forEach(doc => {
              const d = doc.data() || {};
              let dateTsMs = 0;
              try{
                if (d.dateTs && typeof d.dateTs.toMillis === "function") dateTsMs = d.dateTs.toMillis();
              }catch{}
              trades.push({ ...d, dateTsMs });
            });

            state.trades = trades;
            replayIndex = Math.max(0, state.trades.length - 1);

            refreshDashboard();
            refreshAnalytics();
            refreshReplay();
            refreshStreaks();
            refreshCalendar();
            updateCharts();
          }, (err) => {
            console.error(err);
            alert("Firestore sync failed. Check Firestore rules + indexes.");
          });
      }

      // ---------- Boot ----------
      clearForm();
      initCharts();
      attachTradesListener();

      refreshDashboard();
      refreshAnalytics();
      refreshReplay();
      refreshStreaks();
      refreshCalendar();
      updateCharts();
    }
  </script>
</body>
</html>
