<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FYNX Finance World - Live News</title>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel-soft: rgba(11,11,12,0.04);
      --text:#0b0b0c;
      --muted:#5b616a;
      --line: rgba(11,11,12,0.10);

      --brand:#0b0b0c;
      --brand-soft: rgba(11,11,12,0.08);

      --shadow: 0 18px 38px rgba(0,0,0,0.06);
      --focus: 0 0 0 3px rgba(11,11,12,0.18);
      --nav-w: 120px;
    }

    body.dark-mode{
      --bg:#000000;
      --panel:#0b0b0c;
      --panel-soft: rgba(242,243,245,0.08);
      --text:#f2f3f5;
      --muted:#a9b0bb;
      --line: rgba(242,243,245,0.12);

      --brand:#f2f3f5;
      --brand-soft: rgba(242,243,245,0.10);

      --shadow: 0 20px 44px rgba(0,0,0,0.55);
      --focus: 0 0 0 3px rgba(242,243,245,0.18);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Inter", system-ui, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background 0.25s ease, color 0.25s ease;
      background:
        radial-gradient(circle at 1px 1px, rgba(0,0,0,0.06) 1px, transparent 1px) 0 0 / 18px 18px,
        linear-gradient(var(--bg), var(--bg));
    }

    body.dark-mode{
      background:
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px) 0 0 / 26px 26px,
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px) 0 0 / 26px 26px,
        radial-gradient(circle at 40% 10%, rgba(255,255,255,0.06) 0%, transparent 45%),
        radial-gradient(circle at 70% 0%, rgba(255,255,255,0.04) 0%, transparent 40%),
        linear-gradient(var(--bg), var(--bg));
    }

    .dashboard-container{ display:flex; min-height:100vh; }

    .nav-panel{
      width: var(--nav-w);
      background: color-mix(in oklab, var(--panel) 92%, transparent);
      border-right: 1px solid var(--line);
      display:flex;
      flex-direction:column;
      position:fixed;
      left:0; top:0;
      height:100vh;
      z-index:10;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }

    .nav-logo{
      padding: 28px 0;
      text-align:center;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(145deg, transparent, rgba(0,0,0,0.04));
    }
    body.dark-mode .nav-logo{
      background: linear-gradient(145deg, transparent, rgba(255,255,255,0.03));
    }

    .nav-logo h1{
      font-size:20px;
      font-weight:900;
      letter-spacing:0.6px;
    }

    .nav-menu{
      flex:1;
      padding:24px 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    .nav-item{
      width:80px;
      padding:14px 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      border-radius:10px;
      cursor:pointer;
      color: var(--muted);
      transition: background 0.18s ease, color 0.18s ease, transform 0.18s ease, border-color 0.18s ease;
      text-decoration:none;
      border: 1px solid transparent;
      user-select:none;
    }

    .nav-item:hover{
      background: var(--panel-soft);
      color: var(--text);
      border-color: var(--line);
      transform: translateY(-1px);
    }

    .nav-item.active{
      background: var(--brand-soft);
      color: var(--text);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .nav-icon{ width:20px; height:20px; stroke: currentColor; stroke-width:1.7; fill:none; }
    .nav-label{ font-size:11px; font-weight:800; }

    .main-content{
      margin-left: var(--nav-w);
      width: calc(100% - var(--nav-w));
      display:flex;
      flex-direction:column;
    }

    .top-bar{
      position:sticky;
      top:0;
      z-index:8;
      height:68px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 22px;
      background: color-mix(in oklab, var(--panel) 88%, transparent);
      backdrop-filter: blur(10px);
    }

    .page-title{ font-size:16px; font-weight:900; letter-spacing:-0.2px; }

    .top-bar-right{ display:flex; align-items:center; gap:12px; }

    .chip{
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--muted);
      border-radius: 999px;
      font-size: 12px;
      padding: 8px 12px;
      font-weight: 900;
    }

    .notification-icon{
      width:34px;
      height:34px;
      border-radius:10px;
      border: 1px solid var(--line);
      background: var(--panel);
      display:grid;
      place-items:center;
      cursor:pointer;
      color: var(--muted);
      transition: 0.18s ease;
    }

    .notification-icon:hover{
      color: var(--text);
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .notification-icon svg{
      width:18px; height:18px;
      stroke: currentColor;
      fill:none;
      stroke-width:1.8;
    }

    .user-avatar{
      width:34px; height:34px;
      border-radius:999px;
      background: var(--brand-soft);
      color: var(--text);
      border: 1px solid var(--line);
      display:grid;
      place-items:center;
      font-size:12px;
      font-weight:900;
    }

    .content-area{
      padding:20px;
      display:grid;
      gap:16px;
    }

    .panel{
      background: color-mix(in oklab, var(--panel) 92%, transparent);
      border: 1px solid var(--line);
      border-radius:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .ticker-wrap{ overflow:hidden; }

    .ticker-label{
      font-size:11px;
      font-weight:900;
      letter-spacing:0.7px;
      text-transform:uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--line);
      padding: 8px 12px;
      background: var(--panel-soft);
    }

    .ticker{
      display:flex;
      gap:26px;
      padding: 10px 14px;
      white-space:nowrap;
      overflow-x:auto;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }

    .ticker-item{ font-size:13px; font-weight:900; }
    .ticker-item .p, .ticker-item .n{ color: var(--text); }

    .news-layout{
      display:grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap:16px;
    }

    .filters{
      padding:16px;
      display:grid;
      gap:12px;
      align-content:start;
      position: sticky;
      top: 84px;
      max-height: calc(100vh - 104px);
      overflow:auto;
    }

    .section-title{
      font-size:13px;
      font-weight:900;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:0.7px;
    }

    .search{
      width:100%;
      padding:10px 12px;
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--text);
      border-radius:10px;
      font-size:14px;
      outline:none;
    }

    .search:focus{
      box-shadow: var(--focus);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .btn-row{ display:flex; flex-wrap:wrap; gap:8px; }

    .filter-btn{
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--muted);
      border-radius:999px;
      padding: 8px 11px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      transition: 0.18s ease;
    }

    .filter-btn:hover{
      color: var(--text);
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .filter-btn.active{
      background: var(--brand-soft);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
      color: var(--text);
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }

    .stat{
      background: var(--panel-soft);
      border: 1px solid var(--line);
      border-radius:10px;
      padding:10px;
    }

    .stat-value{ font-size:18px; font-weight:900; }
    .stat-label{
      font-size:11px;
      font-weight:900;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:0.6px;
    }

    .news-panel{ padding:12px; }

    .section-header{
      padding: 8px 8px 16px;
      display:flex;
      align-items:start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line);
      margin-bottom:10px;
    }

    .section-header h2{
      font-size:26px;
      line-height:1.1;
      font-weight: 900;
      letter-spacing:-0.7px;
    }

    .section-header p{
      color: var(--muted);
      font-size:13px;
      margin-top:4px;
      font-weight: 800;
    }

    .refresh-btn{
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--text);
      border-radius:10px;
      padding: 9px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      transition: 0.18s ease;
    }

    .refresh-btn:hover{
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .refresh-btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }

    .news-feed{
      display:grid;
      gap:10px;
      max-height: calc(100vh - 236px);
      overflow:auto;
      padding-right:4px;
      -webkit-overflow-scrolling: touch;
    }

    .news-card{
      border: 1px solid var(--line);
      border-radius:12px;
      background: var(--panel-soft);
      padding:14px;
      transition: transform 0.18s ease, border-color 0.18s ease;
    }

    .news-card:hover{
      transform: translateY(-1px);
      border-color: color-mix(in oklab, var(--text) 18%, var(--line));
    }

    .news-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:11px;
      margin-bottom:9px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:0.6px;
      font-weight:900;
    }

    .pill{
      border: 1px solid var(--line);
      border-radius:999px;
      padding: 3px 7px;
      background: var(--panel);
      color: var(--muted);
    }

    .news-title{
      font-size:19px;
      line-height:1.4;
      margin-bottom:8px;
      font-weight: 900;
      letter-spacing:-0.2px;
    }

    .news-title a{ color: inherit; text-decoration:none; }
    .news-title a:hover{ text-decoration: underline; }

    .news-excerpt{
      font-size:14px;
      color: var(--muted);
      line-height:1.55;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      font-weight: 700;
    }

    .status-row{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      font-weight: 800;
    }

    .skeleton{
      border: 1px solid var(--line);
      border-radius:10px;
      background: linear-gradient(
        90deg,
        var(--panel-soft),
        color-mix(in oklab, var(--panel-soft) 80%, var(--line)),
        var(--panel-soft)
      );
      background-size: 200% 100%;
      animation: shimmer 1.4s linear infinite;
      height:108px;
    }

    @keyframes shimmer{ from{ background-position:200% 0; } to{ background-position:-200% 0; } }

    .empty{
      border: 1px dashed var(--line);
      border-radius:12px;
      padding:22px;
      text-align:center;
      color: var(--muted);
      font-weight: 900;
    }

    .banner{
      border:1px solid var(--line);
      background: var(--panel-soft);
      border-radius:12px;
      padding:12px 14px;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      white-space: pre-wrap;
    }

    @media (max-width:1080px){
      .news-layout{ grid-template-columns: 1fr; }
      .filters{ position: static; max-height:none; }
      .news-feed{ max-height:none; }
    }

    @media (max-width:720px){
      .nav-panel{
        width:100%;
        height:74px;
        top:auto;
        bottom:0;
        left:0;
        right:0;
        border-right:0;
        border-top: 1px solid var(--line);
        flex-direction: row;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .nav-logo{ display:none; }
      .nav-menu{
        width:100%;
        flex-direction: row;
        justify-content: space-around;
        padding:8px;
      }
      .nav-item{ width:auto; padding:8px 10px; }
      .main-content{
        margin-left:0;
        width:100%;
        padding-bottom: calc(88px + env(safe-area-inset-bottom));
      }
      .top-bar{ padding:0 12px; }
      .section-header h2{ font-size:23px; }
      .content-area{ padding:12px; }
      .filters{ top:auto; }
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <nav class="nav-panel">
      <div class="nav-logo"><h1>FYNX</h1></div>
      <div class="nav-menu">
        <a class="nav-item" href="home.html" data-view="home">
          <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span class="nav-label">Home</span>
        </a>
        <a class="nav-item" href="journal.html" data-view="journal">
          <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
          <span class="nav-label">Journal</span>
        </a>
        <a class="nav-item" href="calculator.html" data-view="calculator">
          <svg class="nav-icon" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="8" y1="10" x2="16" y2="10"></line><line x1="8" y1="14" x2="16" y2="14"></line><line x1="8" y1="18" x2="16" y2="18"></line></svg>
          <span class="nav-label">Calculator</span>
        </a>
        <a class="nav-item active" href="news.html" data-view="news">
          <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><line x1="12" y1="11" x2="18" y2="11"></line><line x1="12" y1="7" x2="18" y2="7"></line></svg>
          <span class="nav-label">News</span>
        </a>
        <a class="nav-item" href="calendar.html" data-view="calendar">
          <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span class="nav-label">Calendar</span>
        </a>
        <a class="nav-item" href="profile.html" data-view="profile">
          <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          <span class="nav-label">Profile</span>
        </a>
      </div>
    </nav>

    <main class="main-content">
      <div class="top-bar">
        <h1 class="page-title">Live Finance News</h1>
        <div class="top-bar-right">
          <span class="chip" id="lastUpdated">Updating...</span>
          <button class="notification-icon" aria-label="Alerts">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
          </button>
          <div class="user-avatar">FX</div>
        </div>
      </div>

      <div class="content-area">
        <div id="proxyBanner" class="banner" style="display:none;"></div>

        <section class="ticker-wrap panel">
          <div class="ticker-label">Market Pulse</div>
          <div class="ticker" id="ticker"></div>
        </section>

        <section class="news-layout">
          <aside class="panel filters">
            <div>
              <div class="section-title">Search</div>
              <input id="searchInput" class="search" placeholder="Search topic, source, region..." />
            </div>

            <div>
              <div class="section-title">Region</div>
              <div class="btn-row" id="regionFilters"></div>
            </div>

            <div>
              <div class="section-title">Topic</div>
              <div class="btn-row" id="topicFilters"></div>
            </div>

            <div>
              <div class="section-title">Live Stats</div>
              <div class="stats">
                <div class="stat"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Articles</div></div>
                <div class="stat"><div class="stat-value" id="sourceCount">0</div><div class="stat-label">Sources</div></div>
              </div>
            </div>
          </aside>

          <div class="panel news-panel">
            <div class="section-header">
              <div>
                <h2>Global Finance Wire</h2>
                <p>Markets, macro, equities, rates, FX, commodities, crypto, banking.</p>
              </div>
              <button id="refreshBtn" class="refresh-btn">Refresh now</button>
            </div>

            <div id="newsFeed" class="news-feed"></div>
            <div id="statusText" class="status-row"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    /***********************************************************
      ✅ HIGH VERSION / PERFECT FIX
      - Loads in TWO STAGES so it never shows empty:
        Stage A (fast): 6 baseline feeds
        Stage B (extra): more feeds AFTER baseline succeeds
      - Limits parallel requests (prevents Google RSS throttling)
      - Caches last good results in localStorage (instant UI on reload)
      - Better error + debug messages (shows which feeds failed)
      - Works with your Worker route: /rss?url=<encoded>
    ***********************************************************/
    const RSS_PROXY_ENDPOINT = "/rss?url=";

    const state = {
      allNews: [],
      filtered: [],
      region: "All",
      topic: "All",
      query: "",
      symbol: "All",

      autoRefreshMs: 5 * 60 * 1000,
      lastFetchAt: 0,
      minManualRefreshMs: 15 * 1000,

      maxParallel: 4,       // ✅ key: reduces feed failures
      baselineJobs: 6,      // ✅ stage A count
      maxJobsTotal: 12,     // ✅ stage A + stage B total (stable)
      debug: false
    };

    const REGIONS = ["All", "US", "Europe", "Asia", "Middle East", "Africa", "LatAm", "Global"];
    const TOPICS  = ["All", "Markets", "Macro", "Equities", "Rates", "FX", "Commodities", "Crypto", "Banking"];

    const FEEDS = [
      { region:"US", topic:"Markets",     q:"stock market OR wall street OR dow OR nasdaq OR s&p" },
      { region:"US", topic:"Macro",       q:"fed OR CPI OR jobs report OR GDP OR inflation" },
      { region:"US", topic:"Equities",    q:"earnings OR IPO OR shares OR equities" },
      { region:"US", topic:"Rates",       q:"treasury yields OR bond market OR interest rates" },
      { region:"US", topic:"FX",          q:"dollar index OR USD OR forex" },
      { region:"US", topic:"Commodities", q:"oil prices OR WTI OR brent OR gold prices" },
      { region:"US", topic:"Crypto",      q:"bitcoin OR ethereum OR crypto market" },
      { region:"US", topic:"Banking",     q:"banks OR banking regulation OR credit markets" },

      { region:"Europe", topic:"Markets",     q:"europe markets OR stoxx OR dax OR ftse" },
      { region:"Europe", topic:"Macro",       q:"ECB OR eurozone inflation OR eurozone GDP" },
      { region:"Europe", topic:"Equities",    q:"europe equities OR european stocks OR earnings" },
      { region:"Europe", topic:"Rates",       q:"europe bond yields OR gilts OR bund yields" },
      { region:"Europe", topic:"FX",          q:"EURUSD OR euro OR pound OR GBPUSD" },
      { region:"Europe", topic:"Commodities", q:"brent OR energy prices europe" },
      { region:"Europe", topic:"Crypto",      q:"crypto europe OR bitcoin europe" },
      { region:"Europe", topic:"Banking",     q:"europe banks OR banking supervision" },

      { region:"Asia", topic:"Markets",     q:"asia markets OR nikkei OR hang seng OR shanghai" },
      { region:"Asia", topic:"Macro",       q:"china economy OR japan inflation OR asia GDP" },
      { region:"Asia", topic:"Equities",    q:"asia stocks OR earnings asia" },
      { region:"Asia", topic:"Rates",       q:"japan bond yields OR boj OR rates asia" },
      { region:"Asia", topic:"FX",          q:"USDJPY OR yen OR yuan OR CNY" },
      { region:"Asia", topic:"Commodities", q:"oil demand asia OR gold demand" },
      { region:"Asia", topic:"Crypto",      q:"crypto asia OR bitcoin asia" },
      { region:"Asia", topic:"Banking",     q:"asia banks OR bank regulation asia" },

      { region:"Middle East", topic:"Markets",     q:"middle east markets OR gulf markets" },
      { region:"Middle East", topic:"Macro",       q:"middle east economy OR inflation" },
      { region:"Middle East", topic:"Equities",    q:"middle east stocks OR IPO" },
      { region:"Middle East", topic:"Rates",       q:"rates OR central bank middle east" },
      { region:"Middle East", topic:"FX",          q:"currency OR forex middle east" },
      { region:"Middle East", topic:"Commodities", q:"OPEC OR oil market OR brent" },
      { region:"Middle East", topic:"Crypto",      q:"crypto middle east" },
      { region:"Middle East", topic:"Banking",     q:"banks middle east OR banking regulation" },

      { region:"Africa", topic:"Markets",     q:"africa markets OR african stocks" },
      { region:"Africa", topic:"Macro",       q:"africa economy OR IMF africa OR inflation africa" },
      { region:"Africa", topic:"Equities",    q:"africa equities OR IPO africa" },
      { region:"Africa", topic:"Rates",       q:"interest rates africa OR central bank africa" },
      { region:"Africa", topic:"FX",          q:"forex africa OR currency africa" },
      { region:"Africa", topic:"Commodities", q:"gold africa OR oil africa OR commodities africa" },
      { region:"Africa", topic:"Crypto",      q:"crypto africa OR bitcoin africa" },
      { region:"Africa", topic:"Banking",     q:"banks africa OR banking regulation africa" },

      { region:"LatAm", topic:"Markets",     q:"latin america markets OR brazil stocks OR mexico stocks" },
      { region:"LatAm", topic:"Macro",       q:"latin america economy OR inflation brazil OR GDP mexico" },
      { region:"LatAm", topic:"Equities",    q:"latin america equities OR earnings" },
      { region:"LatAm", topic:"Rates",       q:"rates brazil OR central bank brazil OR bond yields" },
      { region:"LatAm", topic:"FX",          q:"USDMXN OR USDBRL OR peso OR real currency" },
      { region:"LatAm", topic:"Commodities", q:"oil mexico OR commodities brazil" },
      { region:"LatAm", topic:"Crypto",      q:"crypto latin america OR bitcoin brazil" },
      { region:"LatAm", topic:"Banking",     q:"banks latin america OR banking regulation" },

      { region:"Global", topic:"Markets",     q:"global markets OR world stocks OR risk-on risk-off" },
      { region:"Global", topic:"Macro",       q:"global economy OR IMF OR world inflation OR recession" },
      { region:"Global", topic:"Equities",    q:"global stocks OR earnings season" },
      { region:"Global", topic:"Rates",       q:"global bond yields OR interest rates" },
      { region:"Global", topic:"FX",          q:"forex OR dollar index OR DXY OR EURUSD" },
      { region:"Global", topic:"Commodities", q:"oil prices OR brent OR gold prices OR copper prices" },
      { region:"Global", topic:"Crypto",      q:"bitcoin OR ethereum OR crypto regulation" },
      { region:"Global", topic:"Banking",     q:"banking crisis OR bank regulation OR credit markets" }
    ];

    const MARKET_TICKER = [
      { symbol: "S&P 500", value: "+0.41%", positive: true  },
      { symbol: "NASDAQ",  value: "+0.72%", positive: true  },
      { symbol: "DXY",     value: "-0.19%", positive: false },
      { symbol: "US10Y",   value: "+0.03",  positive: true  },
      { symbol: "Brent",   value: "-0.48%", positive: false },
      { symbol: "Gold",    value: "+0.27%", positive: true  },
      { symbol: "BTC",     value: "+1.12%", positive: true  },
      { symbol: "ETH",     value: "-0.66%", positive: false }
    ];

    const SYMBOL_QUERY = {
      "S&P 500": "(S&P 500 OR SPX OR \"US equity market\")",
      "NASDAQ":  "(NASDAQ OR NDX OR \"Nasdaq composite\")",
      "DXY":     "(DXY OR \"dollar index\")",
      "US10Y":   "(US10Y OR \"10-year treasury\" OR \"Treasury yield\")",
      "Brent":   "(Brent OR \"Brent crude\" OR OPEC OR \"oil prices\")",
      "Gold":    "(Gold OR XAU OR \"gold prices\" OR bullion)",
      "BTC":     "(Bitcoin OR BTC)",
      "ETH":     "(Ethereum OR ETH)"
    };

    const newsFeed     = document.getElementById("newsFeed");
    const statusText   = document.getElementById("statusText");
    const lastUpdated  = document.getElementById("lastUpdated");
    const searchInput  = document.getElementById("searchInput");
    const refreshBtn   = document.getElementById("refreshBtn");
    const totalCount   = document.getElementById("totalCount");
    const sourceCount  = document.getElementById("sourceCount");
    const proxyBanner  = document.getElementById("proxyBanner");

    const THEME_KEY = "fynx_theme";
    (function applySavedTheme(){
      const saved = localStorage.getItem(THEME_KEY) || "light";
      document.body.classList.toggle("dark-mode", saved === "dark");
    })();

    (function renderAvatar(){
      const NAME_KEYS = ["fynx_profile_name","fynx_username","username","profile_name","user_name","fynx_name","fynxUserName","displayName","name"];
      const PROFILE_JSON_KEYS = ["fynx_profile","profile","fynx_user","userProfile","fynx_account"];
      const clean = (s)=>String(s||"").trim().replace(/[.!,;:]+$/g,"").trim();
      const pickJson = (obj)=>{
        if(!obj||typeof obj!=="object") return null;
        return obj.username||obj.userName||obj.name||obj.displayName||obj.fullName||obj.profile?.username||obj.profile?.name||obj.profile?.displayName||null;
      };
      const getName=()=>{
        for(const k of NAME_KEYS){
          const v=localStorage.getItem(k);
          if(v&&clean(v)) return clean(v);
        }
        for(const k of PROFILE_JSON_KEYS){
          const raw=localStorage.getItem(k);
          if(!raw) continue;
          try{ const obj=JSON.parse(raw); const n=pickJson(obj); if(n&&clean(n)) return clean(n); }catch(e){}
        }
        return null;
      };
      const el=document.querySelector(".user-avatar");
      const name=getName();
      if(!el){return;}
      if(!name){ el.textContent="FX"; return; }
      const parts=name.split(/\s+/).filter(Boolean);
      let initials=parts[0]?.[0]||"F";
      if(parts.length>1) initials += parts[parts.length-1]?.[0]||"";
      el.textContent=initials.toUpperCase();
    })();

    function safeText(raw=""){
      const div=document.createElement("div");
      div.innerHTML=raw;
      return (div.textContent||"").trim();
    }

    function classifyTopic(title="", desc=""){
      const text = `${title} ${desc}`.toLowerCase();
      if (/crypto|bitcoin|ethereum|token|blockchain/.test(text)) return "Crypto";
      if (/oil|gas|gold|silver|copper|commodity|opec|brent|wti/.test(text)) return "Commodities";
      if (/forex|currency|dollar|euro|yen|fx|dxy|eurusd|usdjpy/.test(text)) return "FX";
      if (/bond|yield|treasury|rate|fed|ecb|boj|central bank/.test(text)) return "Rates";
      if (/bank|lender|credit|loan|deposit/.test(text)) return "Banking";
      if (/inflation|gdp|jobs|macro|economy|recession|imf/.test(text)) return "Macro";
      if (/stock|equity|shares|ipo|earnings|nasdaq|s&p|stoxx|ftse|dax/.test(text)) return "Equities";
      return "Markets";
    }

    function formatRelativeTime(dateValue){
      const t = new Date(dateValue).getTime();
      if (!Number.isFinite(t)) return "recent";
      const diff = Date.now() - t;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const days = Math.floor(hrs / 24);
      return `${days}d ago`;
    }

    function buildTicker(){
      const el = document.getElementById("ticker");
      el.innerHTML = MARKET_TICKER.map(item => `
        <div class="ticker-item" role="button" tabindex="0" data-symbol="${item.symbol}" style="cursor:pointer;">
          ${item.symbol}: <span class="${item.positive ? "p" : "n"}">${item.value}</span>
        </div>
      `).join("");

      el.querySelectorAll(".ticker-item").forEach(node => {
        const sym = node.dataset.symbol;
        const activate = () => { state.symbol = sym || "All"; refreshNews(true, true); };
        node.addEventListener("click", activate);
        node.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activate(); }
        });
      });
    }

    function buildFilterButtons(containerId, values, activeValue, onPick){
      const el = document.getElementById(containerId);
      el.innerHTML = values.map(v => `<button class="filter-btn ${v===activeValue?"active":""}" data-value="${v}">${v}</button>`).join("");
      el.querySelectorAll(".filter-btn").forEach(btn => btn.addEventListener("click", ()=>onPick(btn.dataset.value)));
    }

    function renderSkeleton(){
      newsFeed.innerHTML = Array.from({ length: 10 }).map(() => `<div class="skeleton"></div>`).join("");
      statusText.textContent = "Loading live finance feeds...";
    }

    function renderNews(){
      totalCount.textContent = state.filtered.length;
      sourceCount.textContent = new Set(state.filtered.map(n => n.source)).size;

      if (!state.filtered.length){
        newsFeed.innerHTML = `<div class="empty">No articles match this filter. Try another region/topic or clear search.</div>`;
        return;
      }

      newsFeed.innerHTML = state.filtered.map(item => `
        <article class="news-card">
          <div class="news-meta">
            <span class="pill">${item.topic}</span>
            <span class="pill">${item.region}</span>
            <span class="pill">${item.source}</span>
            <span>${formatRelativeTime(item.date)}</span>
          </div>
          <h3 class="news-title">
            <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
          </h3>
          <p class="news-excerpt">${item.description || "Open article for full details."}</p>
        </article>
      `).join("");
    }

    function applyFilters(){
      const query = state.query.trim().toLowerCase();
      state.filtered = state.allNews.filter(item => {
        const regionOk = state.region === "All" || item.region === state.region || (state.region !== "Global" && item.region === "Global");
        const topicOk  = state.topic === "All" || item.topic === state.topic;
        const queryOk  = !query || `${item.title} ${item.source} ${item.description}`.toLowerCase().includes(query);
        return regionOk && topicOk && queryOk;
      });

      if (state.symbol !== "All") state.filtered = state.filtered.slice(0, 50);
      renderNews();
    }

    function makeGoogleRssUrl(query, locale){
      const hl = locale?.hl || "en-US";
      const gl = locale?.gl || "US";
      const ceid = locale?.ceid || "US:en";
      const when = "when:1d";
      return `https://news.google.com/rss/search?q=${encodeURIComponent(`${query} ${when}`)}&hl=${encodeURIComponent(hl)}&gl=${encodeURIComponent(gl)}&ceid=${encodeURIComponent(ceid)}`;
    }

    async function fetchViaYourProxy(rssUrl){
      const url = RSS_PROXY_ENDPOINT + encodeURIComponent(rssUrl);
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      if (!res.ok) throw new Error(`Proxy HTTP ${res.status}: ${text.slice(0, 140)}`);
      return text;
    }

    function parseXmlOrThrow(text){
      const xml = new DOMParser().parseFromString(text, "application/xml");
      if (xml.querySelector("parsererror")) throw new Error("Invalid XML (proxy returned non-XML)");
      const hasItems = xml.querySelector("item") || xml.querySelector("entry");
      if (!hasItems) throw new Error("No items in feed");
      return xml;
    }

    function getFirstText(node, selectors){
      for (const sel of selectors){
        const v = node.querySelector(sel)?.textContent;
        if (v && String(v).trim()) return safeText(v);
      }
      return "";
    }

    function parseFeed(xml, meta){
      const rssItems = [...xml.querySelectorAll("item")];
      const atomItems = rssItems.length ? [] : [...xml.querySelectorAll("entry")];
      const items = rssItems.length ? rssItems : atomItems;

      return items.map(item => {
        const titleRSS = getFirstText(item, ["title"]);
        const linkRSS  = getFirstText(item, ["link"]);
        const pubRSS   = getFirstText(item, ["pubDate", "published", "updated"]);
        const descRSS  = getFirstText(item, ["description", "content", "content\\:encoded"]);
        const sourceRSS= getFirstText(item, ["source"]);

        let atomHref = "";
        if (!linkRSS){
          const linkEl = item.querySelector("link");
          atomHref = linkEl?.getAttribute("href") || "";
        }

        const title = titleRSS || "";
        const link  = safeText(linkRSS || atomHref || "");
        const pubDate = pubRSS || new Date().toUTCString();
        const desc  = descRSS || "";
        const source = sourceRSS || (title.includes(" - ") ? title.split(" - ").at(-1) : "Unknown Source");
        const cleanTitle = title.replace(/\s+-\s+[^-]+$/, "").trim() || title;

        return {
          id: `${cleanTitle}|${link}`,
          title: cleanTitle,
          link,
          date: pubDate,
          region: meta.region,
          topic: classifyTopic(cleanTitle, desc) || meta.topic,
          source,
          description: desc
        };
      }).filter(x => x.title && x.link);
    }

    function dedupeAndSort(rows){
      const map = new Map();
      for (const row of rows){
        if (!map.has(row.id)) map.set(row.id, row);
      }
      return [...map.values()].sort((a,b)=> new Date(b.date) - new Date(a.date));
    }

    function showProxyBannerIfNeeded(errorText, details=""){
      proxyBanner.style.display = "block";
      proxyBanner.textContent =
        "NEWS SYSTEM: /rss proxy is required on your domain.\n" +
        "If you see many feed failures, it is usually Google RSS throttling.\n" +
        "This version limits parallel requests + caches results.\n" +
        (errorText ? `\nError: ${errorText}` : "") +
        (details ? `\n\nDetails:\n${details}` : "");
    }

    function getActiveFeedJobs(){
      if (state.symbol !== "All"){
        const q = SYMBOL_QUERY[state.symbol] || state.symbol;
        return [
          { region:"Global", topic:"Markets", rss: makeGoogleRssUrl(q, {hl:"en-US",gl:"US",ceid:"US:en"}) },
          { region:"US",     topic:"Markets", rss: makeGoogleRssUrl(q, {hl:"en-US",gl:"US",ceid:"US:en"}) },
          { region:"Europe", topic:"Markets", rss: makeGoogleRssUrl(q, {hl:"en-GB",gl:"GB",ceid:"GB:en"}) },
          { region:"Asia",   topic:"Markets", rss: makeGoogleRssUrl(q, {hl:"en-SG",gl:"SG",ceid:"SG:en"}) }
        ];
      }

      const jobs = [];
      const regionFocus = state.region !== "All" ? state.region : null;
      const topicFocus  = state.topic  !== "All" ? state.topic  : null;

      const add = (r,t)=>{
        const item = FEEDS.find(x=>x.region===r && x.topic===t);
        if(!item) return;
        jobs.push({ region:r, topic:t, rss: makeGoogleRssUrl(item.q) });
      };

      // Baseline (fast)
      add("Global","Markets");
      add("Global","Macro");
      add("Global","Rates");
      add("Global","FX");
      add("Global","Commodities");
      add("Global","Crypto");

      // Focus extras
      if (regionFocus){
        add(regionFocus,"Markets");
        add(regionFocus,"Macro");
        add(regionFocus,"Equities");
        add(regionFocus,"Banking");
      } else {
        add("US","Markets");
        add("Europe","Markets");
        add("Asia","Markets");
        add("US","Macro");
        add("Europe","Macro");
        add("Asia","Macro");
      }

      if (topicFocus){
        add("US", topicFocus);
        add("Europe", topicFocus);
        add("Asia", topicFocus);
        add("Global", topicFocus);
      }

      const seen = new Set();
      const deduped = jobs.filter(j=>{
        const k = `${j.region}|${j.topic}|${j.rss}`;
        if(seen.has(k)) return false;
        seen.add(k);
        return true;
      });

      return deduped.slice(0, state.maxJobsTotal);
    }

    async function runPool(jobs, worker, limit){
      const results = [];
      let i = 0;
      const executing = new Set();

      async function enqueue(){
        if (i >= jobs.length) return;
        const job = jobs[i++];
        const p = (async ()=>{
          try{
            const r = await worker(job);
            results.push({ ok:true, job, value:r });
          }catch(e){
            results.push({ ok:false, job, error: e });
          }
        })();
        executing.add(p);
        p.finally(()=>executing.delete(p));
        if (executing.size >= limit) await Promise.race(executing);
        return enqueue();
      }

      await enqueue();
      await Promise.allSettled([...executing]);
      return results;
    }

    // Cache last good news to avoid empty UI on reload/throttle
    const CACHE_KEY = "fynx_news_cache_v1";
    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.items)) return null;
        // keep cache if < 30 minutes old
        if(Date.now() - (obj.ts||0) > 30*60*1000) return null;
        return obj.items;
      }catch(e){
        return null;
      }
    }
    function saveCache(items){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), items }));
      }catch(e){}
    }

    async function refreshNews(fromTickerClick = false, forceManual = false){
      const now = Date.now();
      if (forceManual){
        if ((now - state.lastFetchAt) < state.minManualRefreshMs) return;
      }
      state.lastFetchAt = now;

      // Show cached data immediately while fetching fresh
      const cached = loadCache();
      if (cached && cached.length){
        state.allNews = cached;
        applyFilters();
        statusText.innerHTML = `<span>${state.filtered.length} showing • ${state.allNews.length} cached</span><span>Refreshing…</span>`;
      } else {
        renderSkeleton();
      }

      refreshBtn.disabled = true;
      proxyBanner.style.display = "none";

      const allJobs = getActiveFeedJobs();
      const baseline = allJobs.slice(0, state.baselineJobs);
      const extras   = allJobs.slice(state.baselineJobs);

      const failedList = [];
      const collected = [];

      try{
        // Stage A: baseline first
        const baseRes = await runPool(baseline, async (job)=>{
          const text = await fetchViaYourProxy(job.rss);
          const xml = parseXmlOrThrow(text);
          return parseFeed(xml, { region: job.region, topic: job.topic });
        }, state.maxParallel);

        for(const r of baseRes){
          if(r.ok) collected.push(...r.value);
          else failedList.push(`${r.job.region}/${r.job.topic}: ${String(r.error?.message || r.error)}`);
        }

        // Update UI early (fast content)
        state.allNews = dedupeAndSort(collected).slice(0, 450);
        if(state.allNews.length){
          saveCache(state.allNews);
          applyFilters();
          if (fromTickerClick) newsFeed.scrollTop = 0;
        }

        // Stage B: extras (only if user didn't select symbol)
        if (extras.length){
          const extraRes = await runPool(extras, async (job)=>{
            const text = await fetchViaYourProxy(job.rss);
            const xml = parseXmlOrThrow(text);
            return parseFeed(xml, { region: job.region, topic: job.topic });
          }, state.maxParallel);

          for(const r of extraRes){
            if(r.ok) collected.push(...r.value);
            else failedList.push(`${r.job.region}/${r.job.topic}: ${String(r.error?.message || r.error)}`);
          }

          state.allNews = dedupeAndSort(collected).slice(0, 450);
          if(state.allNews.length){
            saveCache(state.allNews);
          }
          applyFilters();
        }

        const timeStr = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
        lastUpdated.textContent = `Updated ${timeStr}`;

        statusText.innerHTML =
          `<span>${state.filtered.length} showing • ${state.allNews.length} loaded</span>` +
          `<span>${failedList.length ? `${failedList.length} feed(s) failed.` : "All feeds healthy."}</span>`;

        if (!state.allNews.length){
          showProxyBannerIfNeeded(
            "No articles loaded.",
            failedList.length ? failedList.slice(0, 10).join("\n") : "No failures reported. Check /rss proxy is returning XML."
          );
          newsFeed.innerHTML = `<div class="empty">News not loading. If this keeps happening, it is usually RSS throttling. This build reduces it, but your Worker must be deployed correctly.</div>`;
        } else if (failedList.length && state.debug){
          showProxyBannerIfNeeded("Some feeds failed (debug mode).", failedList.join("\n"));
        }

      }catch(err){
        showProxyBannerIfNeeded(String(err?.message || err));
        newsFeed.innerHTML = `<div class="empty">News not loading. Fix /rss proxy endpoint first.</div>`;
        statusText.textContent = "Feed system error.";
      }finally{
        refreshBtn.disabled = false;
      }
    }

    function bindEvents(){
      searchInput.addEventListener("input", (e) => {
        state.query = e.target.value;
        applyFilters();
      });

      refreshBtn.addEventListener("click", () => refreshNews(false, true));

      const onPickRegion = (value) => {
        state.region = value;
        state.symbol = "All"; // reset symbol mode when changing filters
        buildFilterButtons("regionFilters", REGIONS, state.region, onPickRegion);
        refreshNews(false, true);
      };

      const onPickTopic = (value) => {
        state.topic = value;
        state.symbol = "All";
        buildFilterButtons("topicFilters", TOPICS, state.topic, onPickTopic);
        refreshNews(false, true);
      };

      buildFilterButtons("regionFilters", REGIONS, state.region, onPickRegion);
      buildFilterButtons("topicFilters", TOPICS, state.topic, onPickTopic);
    }

    function startAutoRefresh(){
      setInterval(() => refreshNews(false, false), state.autoRefreshMs);
    }

    (function init(){
      buildTicker();
      bindEvents();
      refreshNews(false, false);
      startAutoRefresh();
    })();
  </script>

  <!-- ✅ CONNECT FX USER CARD (ONLY CHANGE) -->
  <script src="fynx-usercard.js"></script>
</body>
</html>
